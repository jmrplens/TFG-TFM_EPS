name: Build LaTeX Document

on:
  push:
    branches: [ master, main, modernization ]
  pull_request:
    branches: [ master, main ]
  workflow_dispatch:

# Permisos necesarios para comentar en PRs
permissions:
  contents: read
  pull-requests: write

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Python for Pygments
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
        
    - name: Install Pygments
      run: pip install Pygments
      
    - name: Compile LaTeX document
      uses: xu-cheng/latex-action@v3
      with:
        root_file: main.tex
        latexmk_use_lualatex: true
        latexmk_shell_escape: true
        extra_system_packages: |
          python3-pygments
        
    - name: Upload PDF artifact
      uses: actions/upload-artifact@v4
      with:
        name: TFG-TFM_EPS_UA
        path: main.pdf
        retention-days: 30
        
    - name: Upload PDF to release
      if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: main.pdf
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  
  # Job para generar portadas y comentar en PRs
  generate-covers:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    needs: build
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
        
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y poppler-utils webp texlive-luatex texlive-latex-extra texlive-fonts-extra texlive-lang-spanish latexmk
        
    - name: Install TeX Live full (for LuaLaTeX and fonts)
      uses: xu-cheng/latex-action@v3
      with:
        root_file: main.tex
        latexmk_use_lualatex: true
        latexmk_shell_escape: true
        pre_compile: "exit 0"
        post_compile: "exit 0"
        
    - name: Generate cover pages
      id: covers
      run: |
        cd .herramientas
        python3 generar_portadas.py --no-update-readme 2>&1 | tee portadas_output.txt
        
        # Guardar salida para el comentario
        echo 'COVERS_OUTPUT<<EOF' >> $GITHUB_OUTPUT
        cat portadas_output.txt >> $GITHUB_OUTPUT
        echo 'EOF' >> $GITHUB_OUTPUT
        
    - name: Upload cover images artifact
      uses: actions/upload-artifact@v4
      with:
        name: portadas-preview
        path: .github/images/portadas/
        retention-days: 30
        if-no-files-found: warn
        
    - name: Download PDF artifact
      uses: actions/download-artifact@v4
      with:
        name: TFG-TFM_EPS_UA
        path: ./pdf-artifact
        
    - name: Get artifact URL
      id: artifact-url
      run: |
        # La URL del artefacto se construye con el run_id
        echo "PDF_URL=https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts" >> $GITHUB_OUTPUT
        
    - name: Build cover table
      id: cover-table
      run: |
        # Construir tabla markdown con las portadas generadas
        echo 'COVER_TABLE<<EOF' >> $GITHUB_OUTPUT
        echo "| TitulaciÃ³n | Estado |" >> $GITHUB_OUTPUT
        echo "|------------|--------|" >> $GITHUB_OUTPUT
        
        # Parsear la salida del script para extraer resultados
        while IFS= read -r line; do
          if [[ "$line" =~ \[([0-9]+)/([0-9]+)\]\ ([a-z_]+).*\ (âœ…|âŒ) ]]; then
            titulacion="${BASH_REMATCH[3]}"
            status="${BASH_REMATCH[4]}"
            echo "| \`$titulacion\` | $status |" >> $GITHUB_OUTPUT
          fi
        done < .herramientas/portadas_output.txt
        
        echo 'EOF' >> $GITHUB_OUTPUT
        
    - name: Comment on PR
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const artifactUrl = '${{ steps.artifact-url.outputs.PDF_URL }}';
          const coverTable = `${{ steps.cover-table.outputs.COVER_TABLE }}`;
          const coversOutput = `${{ steps.covers.outputs.COVERS_OUTPUT }}`;
          
          const body = `## ðŸ“„ CompilaciÃ³n del documento
          
          El documento **main.pdf** se ha compilado correctamente.
          
          ### ðŸ“¥ Descargar PDF
          
          Puedes descargar el PDF compilado desde los artefactos de este workflow:
          
          ðŸ‘‰ **[Ver artefactos del workflow](${artifactUrl})**
          
          > **Nota:** Los artefactos estarÃ¡n disponibles durante 30 dÃ­as.
          
          <details>
          <summary>ðŸ“š <strong>Portadas generadas para todas las titulaciones</strong></summary>
          
          ${coverTable}
          
          ---
          
          <details>
          <summary>ðŸ“‹ Log completo de generaciÃ³n</summary>
          
          \`\`\`
          ${coversOutput}
          \`\`\`
          
          </details>
          
          </details>
          
          ---
          *Generado automÃ¡ticamente por GitHub Actions* ðŸ¤–
          `;
          
          // Buscar comentario existente del bot
          const { data: comments } = await github.rest.issues.listComments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
          });
          
          const botComment = comments.find(comment => 
            comment.user.type === 'Bot' && 
            comment.body.includes('ðŸ“„ CompilaciÃ³n del documento')
          );
          
          if (botComment) {
            // Actualizar comentario existente
            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: botComment.id,
              body: body,
            });
          } else {
            // Crear nuevo comentario
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body,
            });
          }

  check-links:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Check README links
      uses: gaurav-nelson/github-action-markdown-link-check@v1
      with:
        use-quiet-mode: 'yes'
        config-file: '.github/mlc_config.json'
      continue-on-error: true
