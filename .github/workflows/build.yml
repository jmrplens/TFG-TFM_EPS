name: Build LaTeX Document

# Run name dinÃ¡mico para mejor visibilidad en la UI
run-name: >-
  ${{ github.event_name == 'pull_request' 
      && format('PR #{0}: {1}', github.event.pull_request.number, github.event.pull_request.title) 
      || format('Build: {0}', github.event.head_commit.message || 'Manual trigger') }}

on:
  push:
    branches: [ main ]
    # Solo compilar si hay cambios relevantes (no solo docs)
    paths:
      - '**.tex'
      - '**.sty'
      - '**.cls'
      - '**.bib'
      - 'recursos/**'
      - 'contenido/**'
      - '.latexmkrc'
      - '.github/workflows/build.yml'
  pull_request:
    branches: [ main ]
    paths:
      - '**.tex'
      - '**.sty'
      - '**.cls'
      - '**.bib'
      - 'recursos/**'
      - 'contenido/**'
      - '.latexmkrc'
      - '.github/workflows/build.yml'
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

# Control de concurrencia: cancela builds anteriores del mismo PR/branch
concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.ref }}
  cancel-in-progress: true

env:
  TEXLIVE_VERSION: "2025"

jobs:
  # 1. Crear comentario inicial en PR (aparece justo despuÃ©s de la descripciÃ³n)
  init-comment:
    name: Iniciar comentario en PR
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    outputs:
      comment_id: ${{ steps.create-comment.outputs.comment_id }}
    
    steps:
    - name: Create or update initial comment
      id: create-comment
      uses: actions/github-script@v8
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
          const sha = context.payload.pull_request.head.sha.substring(0, 7);
          
          const body = `## ðŸ“„ CompilaciÃ³n del documento
          
          â³ **Compilando...** El documento se estÃ¡ procesando.
          
          | Detalle | Valor |
          |---------|-------|
          | **Commit** | \`${sha}\` |
          | **Estado** | ðŸ”„ En progreso |
          
          ðŸ‘‰ **[Ver progreso del workflow](${runUrl})**
          
          ---
          *Generado automÃ¡ticamente por GitHub Actions* ðŸ¤–
          `;
          
          // Buscar comentario existente del bot
          const { data: comments } = await github.rest.issues.listComments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
          });
          
          const botComment = comments.find(comment => 
            comment.user.type === 'Bot' && 
            comment.body.includes('ðŸ“„ CompilaciÃ³n del documento')
          );
          
          let commentId;
          if (botComment) {
            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: botComment.id,
              body: body,
            });
            commentId = botComment.id;
          } else {
            const { data: newComment } = await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body,
            });
            commentId = newComment.id;
          }
          
          core.setOutput('comment_id', commentId);

  # 2. Compilar documento
  build:
    name: Compilar documento LaTeX
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: [init-comment]
    # Ejecutar aunque init-comment se salte (push a main, workflow_dispatch)
    if: always() && !cancelled()
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v6
      
    - name: Compile LaTeX document
      uses: xu-cheng/latex-action@v4
      with:
        root_file: main.tex
        latexmk_use_lualatex: true
        latexmk_shell_escape: true
        os: debian
        extra_system_packages: python3-pip
        pre_compile: |
          pip install --break-system-packages latexminted
          # Deshabilitar DocumentMetadata en CI (el paquete block de TeX Live 2025 es experimental
          # y rompe enumitem). Con hyperxmp cargado en eps-tfg.cls, los metadatos funcionan sin Ã©l.
          sed -i 's/\\input{eps-metadata}/%\\input{eps-metadata}/' main.tex
          echo "Verificando que eps-metadata estÃ¡ comentado:"
          grep -n "eps-metadata" main.tex
        
    - name: Upload PDF artifact
      uses: actions/upload-artifact@v6
      with:
        name: TFG-TFM_EPS_UA
        path: main.pdf
        retention-days: 90
        
    - name: Upload log on failure
      if: failure()
      uses: actions/upload-artifact@v6
      with:
        name: build-logs
        path: |
          *.log
          *.blg
        retention-days: 7

  # 3. Actualizar comentario con resultado final
  comment-pr:
    name: Actualizar comentario en PR
    runs-on: ubuntu-latest
    if: always() && github.event_name == 'pull_request' && !cancelled()
    needs: [init-comment, build]
    
    steps:       
    - name: Update PR comment with result
      uses: actions/github-script@v8
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const buildResult = '${{ needs.build.result }}';
          const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
          const prNumber = context.issue.number;
          const sha = context.payload.pull_request.head.sha.substring(0, 7);
          
          const isSuccess = buildResult === 'success';
          const statusEmoji = isSuccess ? 'âœ…' : 'âŒ';
          const statusText = isSuccess ? 'Compilado correctamente' : 'Error de compilaciÃ³n';
          
          let body = `## ðŸ“„ CompilaciÃ³n del documento
          
          ${statusEmoji} **${statusText}**
          
          | Detalle | Valor |
          |---------|-------|
          | **Commit** | \`${sha}\` |
          | **PR** | #${prNumber} |
          | **TeX Live** | ${{ env.TEXLIVE_VERSION }} |
          `;
          
          if (isSuccess) {
            body += `
          ### ðŸ“¥ Descargar PDF
          
          ðŸ‘‰ **[Ver workflow y descargar artefactos](${runUrl})**
          
          En la secciÃ³n "Artifacts" encontrarÃ¡s el archivo **TFG-TFM_EPS_UA** con el PDF compilado.
          
          > **Nota:** Los artefactos estarÃ¡n disponibles durante 90 dÃ­as.
          `;
          } else {
            body += `
          ### âš ï¸ Error en la compilaciÃ³n
          
          ðŸ‘‰ **[Ver logs del workflow](${runUrl})**
          
          Revisa los logs para identificar el problema.
          `;
          }
          
          body += `
          ---
          *Generado automÃ¡ticamente por GitHub Actions* ðŸ¤–
          `;
          
          // Buscar y actualizar el comentario del bot
          const { data: comments } = await github.rest.issues.listComments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
          });
          
          const botComment = comments.find(comment => 
            comment.user.type === 'Bot' && 
            comment.body.includes('ðŸ“„ CompilaciÃ³n del documento')
          );
          
          if (botComment) {
            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: botComment.id,
              body: body,
            });
          } else {
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body,
            });
          }

  # 4. Verificar enlaces
  check-links:
    name: Verificar enlaces
    runs-on: ubuntu-latest
    # Solo ejecutar si hay cambios en archivos markdown
    if: >-
      github.event_name == 'workflow_dispatch' || 
      contains(github.event.head_commit.modified, '.md') ||
      github.event_name == 'pull_request'
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v6
      
    - name: Check README links
      uses: gaurav-nelson/github-action-markdown-link-check@v1
      with:
        use-quiet-mode: 'yes'
        config-file: '.github/mlc_config.json'
      continue-on-error: true
