%% eps-telecom.sty
%% Componentes para telecomunicaciones, electrónica, robótica
%% Parte de eps-componentes.sty

\ProvidesFile{eps-telecom.sty}[2026/02/03 v2.1.0 Componentes telecom EPS UA]

% ============================================================================
% DEPENDENCIAS
% ============================================================================

\RequirePackage{pgfplots}
\pgfplotsset{compat=1.18}
\usepgfplotslibrary{polar,smithchart}
\RequirePackage{circuitikz}
\IfFileExists{siunitx.sty}{\RequirePackage{siunitx}}{%
  \PackageWarning{eps-telecom}{siunitx no disponible, algunas funciones pueden fallar}%
}

% ============================================================================
% CARTA DE SMITH
% ============================================================================

% Estilo base para carta de Smith
\pgfplotsset{
  eps smith style/.style={
    width=10cm,
    height=10cm,
  },
}

% Entorno para carta de Smith
% Uso: \begin{smithchart}[opciones]
%        \addplot... 
%      \end{smithchart}
\newenvironment{smithchartenv}[1][]{
  \begin{tikzpicture}
    \begin{smithchart}[
      eps smith style,
      #1
    ]
}{
    \end{smithchart}
  \end{tikzpicture}
}

% Carta de Smith con título (estilo Card)
% Uso: \begin{smithchartbox}[título]
%        \smithpoint{0.5}{0.3}{Punto 1}
%      \end{smithchartbox}
\newenvironment{smithchartbox}[1][Carta de Smith]{%
  \begin{tcolorbox}[eps-card, title={\faBroadcastTower~#1}, halign=center]
    \begin{tikzpicture}
      \begin{smithchart}[eps smith style]
}{%
      \end{smithchart}
    \end{tikzpicture}
  \end{tcolorbox}
}

% Punto en carta de Smith con etiqueta
\newcommand{\smithpoint}[3]{%
  \addplot[only marks, mark=*, mark size=3pt, eps-primary] 
    coordinates {(#1,#2)} node[above right, font=\footnotesize] {#3};
}

% Arco de impedancia constante
\newcommand{\smitharc}[2]{%
  \addplot[thick, eps-secondary, domain=#1:#2, samples=100] ({#1/360},{#2}); % Dummy implementation fix
}

% ============================================================================
% DIAGRAMA DE CONSTELACIÓN
% ============================================================================

% Estilo para diagrama de constelación
\pgfplotsset{
  constellation style/.style={
    width=8cm,
    height=8cm,
    axis lines=middle,
    xlabel={I},
    ylabel={Q},
    xmin=-2, xmax=2,
    ymin=-2, ymax=2,
    grid=both,
    grid style={eps-gray!30},
    axis line style={eps-gray},
    tick style={eps-gray},
  },
}

% Entorno para constelación (estilo Card)
% Uso: \begin{constellation}[título]
%        \constpoint{1}{1}
%        \constpoint{1}{-1}
%      \end{constellation}
\newenvironment{constellation}[1][Diagrama de constelación]{
  \begin{tcolorbox}[eps-card, title={\faStar~#1}, halign=center]
    \begin{tikzpicture}
      \begin{axis}[constellation style]
}{
      \end{axis}
    \end{tikzpicture}
  \end{tcolorbox}
}

% Punto de constelación
\newcommand{\constpoint}[2]{%
  \addplot[only marks, mark=*, mark size=4pt, eps-primary] 
    coordinates {(#1,#2)};
}

% Punto con etiqueta de bits
\newcommand{\constpointlabel}[3]{%
  \addplot[only marks, mark=*, mark size=4pt, eps-primary] 
    coordinates {(#1,#2)} node[above right, font=\tiny\ttfamily] {#3};
}

% Constelaciones predefinidas
\newcommand{\qpsk}{%
  \constpointlabel{0.707}{0.707}{00}
  \constpointlabel{-0.707}{0.707}{01}
  \constpointlabel{-0.707}{-0.707}{11}
  \constpointlabel{0.707}{-0.707}{10}
}

% ============================================================================
% DIAGRAMA DE BODE
% ============================================================================

% Estilos para Bode
\pgfplotsset{
  bode magnitude style/.style={
    width=12cm,
    height=5cm,
    xmode=log,
    xlabel={Frecuencia (Hz)},
    ylabel={Magnitud (dB)},
    grid=both,
    grid style={eps-gray!30},
    axis line style={eps-gray},
  },
  bode phase style/.style={
    width=12cm,
    height=4cm,
    xmode=log,
    xlabel={Frecuencia (Hz)},
    ylabel={Fase (°)},
    grid=both,
    grid style={eps-gray!30},
    axis line style={eps-gray},
  },
}

% Entorno para diagrama de Bode
% Uso: \begin{bodeplot}
%        \bodemagnitude{datos}
%        \bodephase{datos}
%      \end{bodeplot}
\newenvironment{bodeplot}{
  \begin{center}
    \begin{tikzpicture}
}{
    \end{tikzpicture}
  \end{center}
}

% ============================================================================
% DIAGRAMA DE BLOQUES
% ============================================================================

% Estilos TikZ para diagramas de bloques
\tikzset{
  % Bloques
  sysblock/.style={
    rectangle, draw=eps-primary, fill=eps-primary!10,
    minimum width=2cm, minimum height=1cm,
    font=\small, align=center, rounded corners=2pt,
  },
  sumblock/.style={
    circle, draw=eps-primary, fill=white,
    minimum size=0.6cm, font=\footnotesize,
  },
  gainblock/.style={
    isosceles triangle, isosceles triangle apex angle=60,
    draw=eps-primary, fill=eps-primary!10,
    minimum width=1cm, minimum height=0.8cm,
    font=\small, shape border rotate=90,
  },
  integratorblock/.style={
    rectangle, draw=eps-secondary, fill=eps-secondary!10,
    minimum width=1.5cm, minimum height=1cm,
    font=\small, align=center,
  },
  delayblock/.style={
    rectangle, draw=eps-warning, fill=eps-warning!10,
    minimum width=1cm, minimum height=0.8cm,
    font=\small, align=center,
  },
  % Conexiones
  sysarrowstyle/.style={
    ->, >=stealth, thick, eps-dark,
  },
  syslabel/.style={
    font=\footnotesize, eps-gray,
  },
  % Puntos de suma
  plusmark/.style={font=\tiny},
  minusmark/.style={font=\tiny},
}

% Símbolos para suma
\newcommand{\plusmark}{\scriptsize$+$}
\newcommand{\minusmark}{\scriptsize$-$}

% Entorno para diagramas de bloques
% Uso: \begin{blockdiagram}...\end{blockdiagram}
\newenvironment{blockdiagram}{%
  \begin{center}
  \begin{tikzpicture}[node distance=2cm]
}{%
  \end{tikzpicture}
  \end{center}
}

% Comando para añadir bloque
% Uso: \sysblock{id}{x,y}{Etiqueta}
\newcommand{\sysblock}[3]{%
  \node[sysblock] (#1) at (#2) {#3};
}

% Comando para flecha entre bloques
% Uso: \sysarrow{origen}{destino}
\newcommand{\sysarrow}[2]{%
  \draw[sysarrowstyle] (#1) -- (#2);
}

% ============================================================================
% CRONOGRAMA DE SEÑALES (TIMING DIAGRAM)
% ============================================================================

% Estilos para timing diagrams
\tikzset{
  timing style/.style={
    x=0.5cm, y=0.6cm,
  },
  timing signal/.style={
    thick, eps-primary,
  },
  timing label/.style={
    font=\footnotesize\ttfamily, anchor=east,
  },
  timing grid/.style={
    very thin, eps-gray!30,
  },
  timing clock/.style={
    thick, eps-secondary,
  },
}

% Comandos para señales
\newcommand{\timinglow}[2]{%
  \draw[timing signal] (#1,0) -- (#2,0);
}
\newcommand{\timinghigh}[2]{%
  \draw[timing signal] (#1,1) -- (#2,1);
}
\newcommand{\timingrise}[1]{%
  \draw[timing signal] (#1,0) -- (#1,1);
}
\newcommand{\timingfall}[1]{%
  \draw[timing signal] (#1,1) -- (#1,0);
}
\newcommand{\timingclock}[3]{% inicio, fin, periodo
  \foreach \i in {#1,#3,...,#2} {
    \draw[timing clock] (\i,0) -- (\i,1) -- (\i+#3/2,1) -- (\i+#3/2,0);
  }
}

% Cronograma de señales (sin caja, centrado)
% Uso: \begin{timingbox}[Cronograma de la comunicación]
%        ... TikZ timing diagram ...
%      \end{timingbox}
\newenvironment{timingbox}[1][Cronograma de señales]{%
  \begin{center}
  {\small\bfseries\faWaveSquare\hspace{0.5em}#1}
  \par\vspace{4pt}
}{%
  \end{center}
}

% ============================================================================
% PARÁMETROS S - Tabla profesional estilo booktabs
% ============================================================================

% Tabla de parámetros S mejorada (sin caja, estilo booktabs)
% Uso: \begin{sparameters}[título opcional]
%        \sparam{1 GHz}{-15.2}{20.5}{-30.1}{-12.3}
%      \end{sparameters}
\newenvironment{sparameters}[1][]{%
  \begingroup
  \small
  \begin{center}
  \ifx\\#1\\%
  \else
    \textbf{#1}\par\vspace{0.5em}
  \fi
  \begin{tabular}{@{}ccccc@{}}
    \toprule
    \textbf{Frecuencia} & \textbf{S\textsubscript{11} (dB)} & \textbf{S\textsubscript{21} (dB)} & \textbf{S\textsubscript{12} (dB)} & \textbf{S\textsubscript{22} (dB)} \\
    \midrule
}{%
    \bottomrule
  \end{tabular}
  \end{center}
  \endgroup
}

% Fila de parámetros S
\newcommand{\sparam}[5]{%
  #1 & #2 & #3 & #4 & #5 \\
}

% Fila con indicador de cumplimiento (para tablas con columna extra)
\newcommand{\sparamrowok}[5]{%
  #1 & #2 & #3 & #4 & #5 & \textcolor{eps-success}{\faCheck} \\
}

\newcommand{\sparamrowfail}[5]{%
  #1 & #2 & #3 & #4 & #5 & \textcolor{eps-danger}{\faTimes} \\
}

% Indicadores inline de cumplimiento
\newcommand{\sparamok}{\textcolor{eps-success}{\faCheck}}
\newcommand{\sparamfail}{\textcolor{eps-danger}{\faTimes}}

% ============================================================================
% DIAGRAMA DE ESTADOS (FSM)
% ============================================================================

% Estilos TikZ para máquinas de estados
\tikzset{
  fsmstate/.style={
    circle, draw=eps-primary, fill=eps-primary!10,
    minimum size=1.2cm, font=\small\bfseries,
  },
  fsminitial/.style={
    fsmstate, fill=eps-success!20, draw=eps-success,
  },
  fsmfinal/.style={
    fsmstate, double, double distance=2pt,
  },
  fsmtransition/.style={
    ->, >=stealth, thick, eps-dark,
    shorten >=2pt, shorten <=2pt,
  },
  fsmlabel/.style={
    font=\footnotesize, fill=white, inner sep=1pt,
  },
  fsmloop/.style={
    looseness=5, in=60, out=120,
  },
}

% Comando para transición con etiqueta
% Uso: \fsmtrans{estado1}{estado2}{etiqueta}
\newcommand{\fsmtrans}[3]{%
  \draw[fsmtransition] (#1) -- node[fsmlabel, above] {#3} (#2);
}

% Entorno para máquinas de estados finitos
% Uso: \begin{fsmdiagram} ... \end{fsmdiagram}
\newenvironment{fsmdiagram}{%
  \begin{center}
  \begin{tikzpicture}[node distance=3cm]
}{%
  \end{tikzpicture}
  \end{center}
}

% Comando para estado FSM
% Uso: \fsmstate{id}{x,y}{etiqueta}{opciones: initial, final o vacío}
\newcommand{\fsmstate}[4]{%
  \ifstrequal{#4}{initial}{%
    \node[fsminitial] (#1) at (#2) {#3};
  }{%
    \ifstrequal{#4}{final}{%
      \node[fsmfinal] (#1) at (#2) {#3};
    }{%
      \node[fsmstate] (#1) at (#2) {#3};
    }%
  }%
}

% ============================================================================
% ANTENAS Y PATRONES DE RADIACIÓN
% ============================================================================

% Estilo para diagrama polar de radiación
\pgfplotsset{
  radiation pattern style/.style={
    width=8cm,
    height=8cm,
    axis lines=none,
    samples=100,
  },
}

% Patrón de radiación (sin caja, centrado)
% Uso: \begin{radiationbox}[Patrón de la antena Yagi]
%        \begin{tikzpicture}...
%      \end{radiationbox}
\newenvironment{radiationbox}[1][Patrón de radiación]{%
  \begin{center}
  {\small\bfseries\faBroadcastTower\hspace{0.5em}#1}
  \par\vspace{4pt}
}{%
  \end{center}
}

% ============================================================================
% ESPECTRO DE FRECUENCIAS
% ============================================================================

% Estilo para espectro
\pgfplotsset{
  spectrum style/.style={
    width=12cm,
    height=5cm,
    xlabel={Frecuencia},
    ylabel={Amplitud (dB)},
    grid=both,
    grid style={eps-gray!30},
    axis line style={eps-gray},
  },
}

% Espectro de frecuencias (sin caja, centrado)
% Uso: \begin{spectrumbox}[Espectro de la señal modulada]
%        \begin{tikzpicture}...
%      \end{spectrumbox}
\newenvironment{spectrumbox}[1][Espectro de frecuencias]{%
  \begin{center}
  {\small\bfseries\faChartArea\hspace{0.5em}#1}
  \par\vspace{4pt}
}{%
  \end{center}
}

% ============================================================================
% DIAGRAMA DE OJO
% ============================================================================

% Estilo para diagrama de ojo
\pgfplotsset{
  eye diagram style/.style={
    width=10cm,
    height=6cm,
    xlabel={Tiempo},
    ylabel={Amplitud},
    xmin=0, xmax=2,
    ymin=-1.5, ymax=1.5,
    axis lines=middle,
    axis line style={eps-gray},
    ticks=none,
  },
}

% Diagrama de ojo (sin caja, centrado)
% Uso: \begin{eyediagrambox}[Diagrama de la señal QPSK]
%        \begin{tikzpicture}...
%      \end{eyediagrambox}
\newenvironment{eyediagrambox}[1][Diagrama de ojo]{%
  \begin{center}
  {\small\bfseries\faEye\hspace{0.5em}#1}
  \par\vspace{4pt}
}{%
  \end{center}
}

% ============================================================================
% ESPECIFICACIONES RF - Tabla profesional estilo datasheet
% ============================================================================

% Tabla de especificaciones estilo datasheet (sin caja)
% Uso: \begin{rfspecs}[título]
%        \rfspec{Frecuencia}{2.4}{GHz}{Nominal}
%        \rfspecrange{Potencia TX}{18}{22}{dBm}{@25°C}
%      \end{rfspecs}
\newenvironment{rfspecs}[1][Especificaciones]{%
  \begingroup
  \small
  \begin{center}
  \textbf{#1}\par\vspace{0.5em}
  \begin{tabular}{@{}lccl@{}}
    \toprule
    \textbf{Parámetro} & \textbf{Valor} & \textbf{Unidad} & \textbf{Condiciones} \\
    \midrule
}{%
    \bottomrule
  \end{tabular}
  \end{center}
  \endgroup
}

% Especificación simple
\newcommand{\rfspec}[4]{%
  #1 & #2 & #3 & #4 \\
}

% Especificación con rango (min-max)
\newcommand{\rfspecrange}[5]{%
  #1 & #2 -- #3 & #4 & #5 \\
}

% Especificación típica con min/typ/max
\newcommand{\rfspecfull}[6]{%
  #1 & #2/#3/#4 & #5 & #6 \\
}

% ============================================================================
% CIRCUITOS CON CIRCUITIKZ
% ============================================================================

% Estilos personalizados para circuitikz
\ctikzset{
  resistors/scale=0.8,
  capacitors/scale=0.8,
  inductors/scale=0.8,
}

% Circuito con CircuiTikZ (sin caja, centrado)
% Uso: \begin{circuitbox}[Filtro paso bajo]
%        \begin{circuitikz}...
%      \end{circuitbox}
\newenvironment{circuitbox}[1][Esquema del circuito]{%
  \begin{center}
  {\small\bfseries\faPlug\hspace{0.5em}#1}
  \par\vspace{4pt}
}{%
  \end{center}
}

% ============================================================================
% PROTOCOLO DE COMUNICACIÓN - TRAMAS DE DATOS
% ============================================================================

% Trama de protocolo estilo bytefield (sin caja)
% Uso: \begin{protocolframe}[bits por fila]
%        \framefield{8}{Preámbulo}
%        \framebreak  % salto de línea opcional
%        \framefield{16}{Dirección}
%      \end{protocolframe}

\newcounter{framepos}
\newcounter{framerow}
\newlength{\framebitwidth}
\newlength{\frameheight}
\setlength{\frameheight}{0.8cm}

% Configuración por defecto: 32 bits por fila
\newcommand{\framebitsperrow}{32}

\newenvironment{protocolframe}[1][32]{%
  \renewcommand{\framebitsperrow}{#1}%
  \setlength{\framebitwidth}{\dimexpr(\linewidth-2em)/#1\relax}%
  \setcounter{framepos}{0}%
  \setcounter{framerow}{0}%
  \centering
  \begin{tikzpicture}[
    x=\framebitwidth,
    y=\frameheight,
    every node/.style={font=\footnotesize}
  ]
    % Regla de bits superior
    \foreach \b in {0,8,...,\numexpr#1-1\relax} {
      \node[above, font=\tiny, eps-gray] at (\b+0.5, 0) {\b};
    }
}{%
  \end{tikzpicture}
}

% Campo de trama básico
\newcommand{\framefield}[2]{%
  \pgfmathsetmacro{\startbit}{Mod(\value{framepos}, \framebitsperrow)}%
  \pgfmathsetmacro{\rownum}{-\value{framerow}}%
  \pgfmathsetmacro{\endbit}{\startbit + #1}%
  % Dibujar campo
  \fill[eps-primary!10, rounded corners=2pt] (\startbit, \rownum) rectangle (\endbit, \rownum-1);
  \draw[eps-primary, thick, rounded corners=2pt] (\startbit, \rownum) rectangle (\endbit, \rownum-1);
  \node[align=center] at ({(\startbit+\endbit)/2}, \rownum-0.5) {#2};
  % Tamaño en bits abajo
  \node[below, font=\tiny, eps-gray] at ({(\startbit+\endbit)/2}, \rownum-1) {#1};
  \addtocounter{framepos}{#1}%
  % Si llegamos al final de la fila, saltar
  \pgfmathtruncatemacro{\newpos}{\value{framepos}}%
  \pgfmathtruncatemacro{\check}{Mod(\newpos, \framebitsperrow)}%
  \ifnum\check=0
    \stepcounter{framerow}%
  \fi
}

% Campo destacado (para campos importantes)
\newcommand{\framefieldhighlight}[2]{%
  \pgfmathsetmacro{\startbit}{Mod(\value{framepos}, \framebitsperrow)}%
  \pgfmathsetmacro{\rownum}{-\value{framerow}}%
  \pgfmathsetmacro{\endbit}{\startbit + #1}%
  \fill[eps-warning!15, rounded corners=2pt] (\startbit, \rownum) rectangle (\endbit, \rownum-1);
  \draw[eps-warning, thick, rounded corners=2pt] (\startbit, \rownum) rectangle (\endbit, \rownum-1);
  \node[align=center, font=\footnotesize\bfseries] at ({(\startbit+\endbit)/2}, \rownum-0.5) {#2};
  \node[below, font=\tiny, eps-gray] at ({(\startbit+\endbit)/2}, \rownum-1) {#1};
  \addtocounter{framepos}{#1}%
  \pgfmathtruncatemacro{\newpos}{\value{framepos}}%
  \pgfmathtruncatemacro{\check}{Mod(\newpos, \framebitsperrow)}%
  \ifnum\check=0
    \stepcounter{framerow}%
  \fi
}

% Campo de datos variable (opcional: primer argumento es el ancho en bits)
% Uso: \framefieldvar{texto} o \framefieldvar[ancho]{texto}
\newcommand{\framefieldvar}[2][\framebitsperrow]{%
  \pgfmathsetmacro{\startbit}{Mod(\value{framepos}, \framebitsperrow)}%
  \pgfmathsetmacro{\rownum}{-\value{framerow}}%
  \pgfmathsetmacro{\endbit}{\startbit + #1}%
  \fill[eps-gray!10, pattern=north east lines, pattern color=eps-gray!30, rounded corners=2pt] 
    (\startbit, \rownum) rectangle (\endbit, \rownum-1);
  \draw[eps-gray, thick, dashed, rounded corners=2pt] (\startbit, \rownum) rectangle (\endbit, \rownum-1);
  \node[align=center] at ({(\startbit+\endbit)/2}, \rownum-0.5) {#2};
  \node[below, font=\tiny, eps-gray] at ({(\startbit+\endbit)/2}, \rownum-1) {variable};
  \addtocounter{framepos}{#1}%
  \pgfmathtruncatemacro{\newpos}{\value{framepos}}%
  \pgfmathtruncatemacro{\check}{Mod(\newpos, \framebitsperrow)}%
  \ifnum\check=0
    \stepcounter{framerow}%
  \fi
}

% Salto manual de línea
\newcommand{\framebreak}{%
  \stepcounter{framerow}%
  \setcounter{framepos}{0}%
}

\endinput
