%% eps-geologia.sty
%% Componentes para geología e ingeniería geológica
%% Parte de eps-componentes.sty

\ProvidesFile{eps-geologia.sty}[2026/02/03 v2.1.0 Componentes geología EPS UA]

% ============================================================================
% DEPENDENCIAS
% ============================================================================

\RequirePackage{pgfplots}
\pgfplotsset{compat=1.18}
\usepgfplotslibrary{polar}
\IfFileExists{siunitx.sty}{\RequirePackage{siunitx}}{%
  \PackageWarning{eps-geologia}{siunitx no disponible}%
}

% ============================================================================
% COLUMNA ESTRATIGRÁFICA
% ============================================================================

% Patrones de litología (simplificados)
\tikzset{
  lito arenisca/.style={pattern=north east lines, pattern color=eps-warning!70},
  lito caliza/.style={pattern=bricks, pattern color=eps-gray},
  lito arcilla/.style={pattern=horizontal lines, pattern color=eps-success!50},
  lito marga/.style={pattern=crosshatch, pattern color=eps-info!50},
  lito conglomerado/.style={pattern=crosshatch dots, pattern color=eps-warning!50},
  lito basalto/.style={fill=eps-dark!70},
  lito granito/.style={pattern=dots, pattern color=eps-danger!50},
}

% Columna estratigráfica (estilo Card, centrada)
% Uso: \begin{stratigraphybox}[Título de la columna]
%        \begin{stratcolumn}...
%      \end{stratigraphybox}
\newenvironment{stratigraphybox}[1][Columna estratigráfica]{%
  \begin{tcolorbox}[eps-card, title={\faLayerGroup~#1}, halign=center]
}{%
  \end{tcolorbox}
}

% Capa estratigráfica
% Uso: \stratlayer{espesor cm}{estilo litología}{nombre}{edad}
\newcommand{\stratlayer}[4]{%
  \draw[thick, #2] (0,\value{stratlayerpos}) rectangle (2,\value{stratlayerpos}+#1);
  \node[right, font=\footnotesize] at (2.2,\value{stratlayerpos}+#1/2) {#3};
  \node[left, font=\tiny, eps-gray] at (0,\value{stratlayerpos}+#1/2) {#4};
  \addtocounter{stratlayerpos}{#1}
}

\newcounter{stratlayerpos}

% Entorno para columna
\newenvironment{stratcolumn}{
  \setcounter{stratlayerpos}{0}
  \begin{tikzpicture}[x=1cm, y=0.5cm]
    % Escala
    \draw[eps-gray, thin] (-0.5,0) -- (-0.5,10);
    \foreach \y in {0,2,...,10} {
      \draw[eps-gray] (-0.6,\y) -- (-0.4,\y);
      \node[left, font=\tiny] at (-0.6,\y) {\y m};
    }
}{
  \end{tikzpicture}
}

% ============================================================================
% SECCIÓN GEOLÓGICA
% ============================================================================

% Sección geológica (estilo Card, centrada)
% Uso: \begin{geologicsectionbox}[Sección A-A']
%        \begin{tikzpicture}...
%      \end{geologicsectionbox}
\newenvironment{geologicsectionbox}[1][Sección geológica]{%
  \begin{tcolorbox}[eps-card, title={\faMountain~#1}, halign=center]
}{%
  \end{tcolorbox}
}

% Símbolos geológicos
\newcommand{\faultline}{%
  \tikz[baseline=-0.3em]{
    \draw[thick, eps-danger] (0,0) -- (0.3,0.2);
    \draw[thick, eps-danger] (0.3,0.2) -- (0.6,0);
  }
}

\newcommand{\anticline}{%
  \tikz[baseline=-0.3em]{
    \draw[thick, eps-primary] (0,0) arc (180:0:0.3);
    \draw[thick, eps-primary, ->] (0.3,0.3) -- (0.3,0.5);
  }
}

\newcommand{\syncline}{%
  \tikz[baseline=-0.3em]{
    \draw[thick, eps-primary] (0,0.3) arc (180:360:0.3);
    \draw[thick, eps-primary, ->] (0.3,0) -- (0.3,-0.2);
  }
}

% ============================================================================
% TABLA DE MINERALES - Estilo profesional
% ============================================================================

% Tabla de propiedades de minerales estilo booktabs (sin caja)
% Uso: \begin{mineraltable}[Minerales de la muestra X]
%        \mineralrow{Cuarzo}{7}{2.65}{Incoloro}{Vítreo}{SiO2}
%      \end{mineraltable}
\newenvironment{mineraltable}[1][Identificación de minerales]{%
  \begingroup
  \small
  \subsection*{#1}
  \begin{tabular}{@{}p{2.5cm}ccp{2cm}p{2cm}l@{}}
    \toprule
    \textbf{Mineral} & \textbf{Dureza} & \textbf{Densidad} & \textbf{Color} & \textbf{Brillo} & \textbf{Composición} \\
    \midrule
}{%
    \bottomrule
  \end{tabular}
  \endgroup
}

\newcommand{\mineralrow}[6]{%
  #1 & #2 & \num{#3} & #4 & #5 & \ch{#6} \\
}

% Grupo de minerales
\newcommand{\mineralgroup}[1]{%
  \midrule
  \multicolumn{6}{@{}l}{\bfseries\textcolor{eps-primary}{#1}} \\
  \midrule
}

% Ficha de mineral compacta (sin caja grande)
\newcommand{\mineralcard}[5]{%
  \noindent
  \begin{minipage}[t]{0.48\textwidth}
    \textcolor{eps-secondary}{\faGem}~{\bfseries #1}\\[4pt]
    {\footnotesize
      \begin{tabular}{@{}ll@{}}
        \textbf{Fórmula:} & \ch{#2} \\
        \textbf{Sistema:} & #3 \\
        \textbf{Dureza:} & #4 \\
        \textbf{Uso:} & #5 \\
      \end{tabular}
    }
  \end{minipage}%
}

% ============================================================================
% ROSA DE VIENTOS / DATOS DIRECCIONALES
% ============================================================================

% Estilo para rosa de vientos
\pgfplotsset{
  windrose style/.style={
    width=8cm,
    height=8cm,
    xmin=0, xmax=360,
    xtick={0,45,...,315},
    xticklabels={N, NE, E, SE, S, SO, O, NO},
    ymin=0,
    ytick style={draw=none},
    x tick label style={font=\footnotesize},
  },
}

% Rosa de orientaciones (sin caja, centrada)
% Uso: \begin{rosebox}[Rosa de fracturas]
%        \begin{tikzpicture}...
%      \end{rosebox}
\newenvironment{rosebox}[1][Rosa de orientaciones]{%
  \begin{center}
  {\small\bfseries\faCompass\hspace{0.5em}#1}
  \par\vspace{4pt}
}{%
  \end{center}
}

% ============================================================================
% DATOS ESTRUCTURALES - Estilo profesional
% ============================================================================

% Tabla de datos estructurales estilo booktabs (sin caja)
% Uso: \begin{structuraldata}[Datos de campo - Zona A]
%        \structurepoint{E-001}{45}{30}{S0}{Estratificación bien marcada}
%      \end{structuraldata}
\newenvironment{structuraldata}[1][Datos estructurales]{%
  \begingroup
  \small
  \subsection*{#1}
  \begin{tabular}{@{}ccccp{4.5cm}@{}}
    \toprule
    \textbf{Estación} & \textbf{Dirección} & \textbf{Buzamiento} & \textbf{Tipo} & \textbf{Observaciones} \\
    \midrule
}{%
    \bottomrule
  \end{tabular}
  \endgroup
}

\newcommand{\structurepoint}[5]{%
  #1 & N#2°E & #3° & #4 & #5 \\
}

% Símbolos de tipo de estructura
\newcommand{\structS}[1]{S$_{#1}$}   % Estratificación
\newcommand{\structF}[1]{F$_{#1}$}   % Fractura/Falla
\newcommand{\structJ}[1]{J$_{#1}$}   % Diaclasa (Joint)

% Símbolo de buzamiento
\newcommand{\dipstrike}[2]{%
  \tikz[baseline=-0.3em]{
    \draw[thick, eps-primary] (0,0) -- (0.5,0);
    \draw[thick, eps-primary] (0.25,0) -- (0.25,-0.2);
    \node[right, font=\tiny] at (0.5,0) {#1/#2};
  }
}

% ============================================================================
% ENSAYOS GEOTÉCNICOS - Estilo profesional
% ============================================================================

% Tabla de ensayos geotécnicos estilo booktabs (sin caja)
% Uso: \begin{geotechdata}[Ensayos sondeo S-01]
%        \geotechtest{Límite líquido}{UNE 103103}{45.2}{\%}{Plasticidad media}
%      \end{geotechdata}
\newenvironment{geotechdata}[1][Ensayos geotécnicos]{%
  \begingroup
  \small
  \subsection*{#1}
  \begin{tabular}{@{}p{3.5cm}crlp{4cm}@{}}
    \toprule
    \textbf{Ensayo} & \textbf{Norma} & \textbf{Valor} & \textbf{Unidad} & \textbf{Clasificación} \\
    \midrule
}{%
    \bottomrule
  \end{tabular}
  \endgroup
}

\newcommand{\geotechtest}[5]{%
  #1 & #2 & \num{#3} & #4 & #5 \\
}

% Grupo de ensayos
\newcommand{\geotechgroup}[1]{%
  \midrule
  \multicolumn{5}{@{}l}{\bfseries\textcolor{eps-primary}{#1}} \\
  \midrule
}

% Parámetros geotécnicos comunes
\newcommand{\sptvalue}[1]{N$_{\text{SPT}}$ = #1}
\newcommand{\cohesion}[1]{c = \SI{#1}{\kilo\pascal}}
\newcommand{\friction}[1]{$\phi$ = #1°}

% ============================================================================
% PERFIL DE SONDEO
% ============================================================================

% Perfil de sondeo (barra lateral coloreada, sin caja completa)
% Uso: \begin{boreholebox}[Sondeo S-01]
%        Contenido del perfil...
%      \end{boreholebox}
\newenvironment{boreholebox}[1][Perfil de sondeo]{%
  \par\vspace{0.5em}
  \noindent
  \begin{minipage}{\linewidth}
    \hspace{3pt}%
    {\color{eps-accent}\vrule width 3pt}%
    \hspace{8pt}%
    \begin{minipage}{\dimexpr\linewidth-14pt\relax}
      {\small\bfseries\faArrowDown\hspace{0.5em}#1}
      \par\vspace{4pt}
}{%
    \end{minipage}
  \end{minipage}
  \par\vspace{0.5em}
}

% Nivel freático
\newcommand{\watertable}[1]{%
  \textcolor{eps-info}{\faTint}~Nivel freático: \SI{#1}{\meter}
}

% ============================================================================
% CLASIFICACIÓN DE SUELOS
% ============================================================================

% Clasificación USCS
\newcommand{\uscsclass}[2]{%
  \begin{tikzpicture}[baseline=-0.3em]
    \node[draw=eps-primary, fill=eps-primary!10, rounded corners=2pt,
          inner sep=4pt, font=\bfseries] {#1};
  \end{tikzpicture}
  ~#2
}

% Clasificación de roca RMR
\newcommand{\rmrclass}[2]{%
  \begin{tikzpicture}[baseline=-0.3em]
    \ifnum#1>80
      \def\rmrcolor{eps-success}
    \else\ifnum#1>60
      \def\rmrcolor{eps-info}
    \else\ifnum#1>40
      \def\rmrcolor{eps-warning}
    \else
      \def\rmrcolor{eps-danger}
    \fi\fi\fi
    \node[draw=\rmrcolor, fill=\rmrcolor!20, rounded corners=2pt,
          inner sep=4pt, font=\small] {RMR = #1 \quad Clase #2};
  \end{tikzpicture}
}

% ============================================================================
% MAPA DE ISOPACAS/ISOLÍNEAS
% ============================================================================

% Mapa de isolíneas (sin caja, centrado)
% Uso: \begin{isolinebox}[Mapa de isopacas]
%        \begin{tikzpicture}...
%      \end{isolinebox}
\newenvironment{isolinebox}[1][Mapa de isolíneas]{%
  \begin{center}
  {\small\bfseries\faMap\hspace{0.5em}#1}
  \par\vspace{4pt}
}{%
  \end{center}
}

% ============================================================================
% ESCALA DE TIEMPO GEOLÓGICO
% ============================================================================

% Época geológica con color
\newcommand{\geoera}[2]{%
  \ifstrequal{#1}{Cuaternario}{\def\@eracolor{eps-warning!30}}{}
  \ifstrequal{#1}{Neógeno}{\def\@eracolor{eps-warning!50}}{}
  \ifstrequal{#1}{Paleógeno}{\def\@eracolor{eps-warning!70}}{}
  \ifstrequal{#1}{Cretácico}{\def\@eracolor{eps-success!50}}{}
  \ifstrequal{#1}{Jurásico}{\def\@eracolor{eps-info!50}}{}
  \ifstrequal{#1}{Triásico}{\def\@eracolor{eps-secondary!50}}{}
  \ifstrequal{#1}{Pérmico}{\def\@eracolor{eps-danger!30}}{}
  \begin{tikzpicture}[baseline=-0.3em]
    \node[fill=\@eracolor, rounded corners=2pt, inner sep=3pt, font=\footnotesize] {#1};
  \end{tikzpicture}
  ~#2
}

% ============================================================================
% RIESGOS GEOLÓGICOS
% ============================================================================

% Alerta de riesgo geológico (estilo barra lateral)
% Uso: \georisk{Título}{Descripción}{eps-danger}
\newcommand{\georisk}[3]{%
  \par\vspace{0.3em}
  \noindent
  \begin{minipage}{\linewidth}
    \hspace{3pt}%
    {\color{#3}\vrule width 3pt}%
    \hspace{8pt}%
    \begin{minipage}{\dimexpr\linewidth-14pt\relax}
      \textcolor{#3}{\faExclamationTriangle}~\textbf{#1}\\[2pt]
      {\footnotesize #2}
    \end{minipage}
  \end{minipage}
  \par\vspace{0.3em}
}

% Riesgos predefinidos
\newcommand{\risklandslide}[1]{\georisk{Riesgo de deslizamiento}{#1}{eps-danger}}
\newcommand{\riskflood}[1]{\georisk{Riesgo de inundación}{#1}{eps-info}}
\newcommand{\riskseismic}[1]{\georisk{Riesgo sísmico}{#1}{eps-warning}}
\newcommand{\risksubsidence}[1]{\georisk{Riesgo de subsidencia}{#1}{eps-secondary}}

\endinput
