%% eps-arquitectura.sty
%% Componentes para arquitectura, edificación, ingeniería civil
%% Parte de eps-componentes.sty

\ProvidesFile{eps-arquitectura.sty}[2026/02/03 v2.1.0 Componentes arquitectura EPS UA]

% ============================================================================
% DEPENDENCIAS
% ============================================================================

\RequirePackage{pgfgantt}
\RequirePackage{eurosym}
% Tachado para normativa derogada (compatible con LuaLaTeX)
\IfPackageLoadedTF{ulem}{}{%
  \IfPackageLoadedTF{soul}{}{%
    \RequirePackage[normalem]{ulem}%
  }%
}
\IfFileExists{siunitx.sty}{%
  \RequirePackage{siunitx}
  \sisetup{
    group-separator={.},
    output-decimal-marker={,},
  }
}{%
  \PackageWarning{eps-arquitectura}{siunitx no disponible}%
}

% ============================================================================
% DIAGRAMA DE GANTT
% ============================================================================

% Estilo personalizado para Gantt
\ganttset{
  eps gantt/.style={
    time slot format=isodate,
    time slot unit=day,
    vgrid={*6{draw=eps-gray!20}, *1{draw=eps-gray!50}},
    hgrid=true,
    x unit=0.08cm,
    y unit title=0.6cm,
    y unit chart=0.5cm,
    title height=1,
    bar height=0.6,
    bar top shift=0.2,
    group top shift=0.2,
    group height=0.6,
    milestone height=0.6,
    title/.style={fill=eps-primary!10, draw=none},
    title label font=\footnotesize\bfseries,
    bar label font=\footnotesize,
    group label font=\footnotesize\bfseries,
    milestone label font=\footnotesize\itshape,
    bar/.style={fill=eps-primary!70, draw=eps-primary},
    bar incomplete/.style={fill=eps-gray!30},
    group/.style={fill=eps-dark, draw=eps-dark},
    group left peak/.style={},
    group right peak/.style={},
    milestone/.style={fill=eps-warning, draw=eps-warning, shape=diamond},
    link/.style={->, eps-gray, thick},
  },
}

% Cronograma del proyecto (sin caja, centrado)
% Uso: \begin{ganttbox}[Cronograma fase I]
%        \begin{ganttchart}[...]{2024-01-01}{2024-06-30}
%          ...
%        \end{ganttchart}
%      \end{ganttbox}
\newenvironment{ganttbox}[1][Cronograma del proyecto]{%
  \par\vspace{0.5em}
  {\small\bfseries\faCalendar\hspace{0.5em}#1}
  \par\vspace{4pt}
}{%
  \par\vspace{0.5em}
}

% Colores para diferentes tipos de tareas
\newcommand{\ganttcritical}[3]{\ganttbar[bar/.style={fill=eps-danger!70, draw=eps-danger}]{#1}{#2}{#3}}
\newcommand{\ganttwarning}[3]{\ganttbar[bar/.style={fill=eps-warning!70, draw=eps-warning}]{#1}{#2}{#3}}
\newcommand{\ganttcomplete}[3]{\ganttbar[bar/.style={fill=eps-success!70, draw=eps-success}]{#1}{#2}{#3}}

% ============================================================================
% FICHA TÉCNICA DE MATERIAL - Estilo profesional
% ============================================================================

% Ficha técnica estilo booktabs (sin caja)
% Uso: \begin{techsheet}{Hormigón HA-25}
%        \techprop{Resistencia característica}{25 MPa}
%        \techsection{Propiedades mecánicas}
%        \techprop{Módulo de elasticidad}{27000 MPa}
%      \end{techsheet}
\newenvironment{techsheet}[1]{%
  \begingroup
  \small
  \subsection*{Ficha técnica: #1}
  \begin{tabular}{@{}p{5.5cm}p{5.5cm}@{}}
    \toprule
    \textbf{Propiedad} & \textbf{Valor} \\
    \midrule
}{%
    \bottomrule
  \end{tabular}
  \endgroup
}

\newcommand{\techprop}[2]{%
  #1 & #2 \\
}

% Sección dentro de ficha técnica
\newcommand{\techsection}[1]{%
  \midrule
  \multicolumn{2}{@{}l}{\bfseries\textcolor{eps-primary}{#1}} \\
  \midrule
}

% Propiedad con unidad separada
\newcommand{\techpropunit}[3]{%
  #1 & #2~#3 \\
}

% Ficha compacta inline (sin caja)
% Uso: \materialcard{Acero S275}{%
%        \techprop{fy}{275 MPa}
%        \techprop{E}{210 GPa}
%      }
\newcommand{\materialcard}[2]{%
  \noindent
  \begin{minipage}[t]{0.48\textwidth}
    {\bfseries\textcolor{eps-primary}{#1}}\\[4pt]
    {\footnotesize
    \begin{tabular}{@{}p{3cm}p{2.5cm}@{}}
      #2
    \end{tabular}}
  \end{minipage}%
}

% ============================================================================
% PRESUPUESTOS Y MEDICIONES - Estilo profesional
% ============================================================================

% Tabla de presupuesto estilo profesional (sin caja)
% Uso: \begin{presupuesto}[título]
%        \capitulo{1}{Movimiento de tierras}
%        \partida{01.01}{Excavación zanja}{m³}{150}{12.50}
%        \subtotal{1875.00}
%      \end{presupuesto}
\newcounter{partidanum}

\newenvironment{presupuesto}[1][Presupuesto]{%
  \begingroup
  \small
  \setcounter{partidanum}{0}
  \subsection*{#1}
  \begin{longtable}{@{}p{1.5cm}p{6cm}crrr@{}}
    \toprule
    \textbf{Código} & \textbf{Descripción} & \textbf{Ud.} & 
    \textbf{Medición} & \textbf{P.U.} & \textbf{Importe} \\
    \midrule
    \endhead
    \midrule
    \multicolumn{6}{r}{\footnotesize\emph{Continúa en la siguiente página...}} \\
    \endfoot
    \bottomrule
    \endlastfoot
}{%
  \end{longtable}
  \endgroup
}

% Partida presupuestaria
\newcommand{\partida}[5]{%
  \texttt{#1} & #2 & #3 & \num{#4} & \num{#5}~\euro & \num[round-mode=places,round-precision=2]{\fpeval{#4*#5}}~\euro \\
}

% Capítulo del presupuesto
\newcommand{\capitulo}[2]{%
  \midrule
  \multicolumn{6}{@{}l}{\bfseries\textcolor{eps-primary}{Capítulo #1: #2}} \\
  \midrule
}

% Subtotal de capítulo
\newcommand{\subtotal}[1]{%
  & & & & \textbf{Subtotal:} & \textbf{\num{#1}~\euro} \\
}

% Total del presupuesto
\newcommand{\totalpresupuesto}[1]{%
  \midrule
  \multicolumn{5}{r}{\bfseries\large Total presupuesto:} & \bfseries\large\num{#1}~\euro \\
}

% IVA y total con impuestos
\newcommand{\totalconiva}[2]{%
  \midrule
  \multicolumn{5}{r}{Base imponible:} & \num{#1}~\euro \\
  \multicolumn{5}{r}{IVA (21\%):} & \num[round-mode=places,round-precision=2]{\fpeval{#1*0.21}}~\euro \\
  \midrule
  \multicolumn{5}{r}{\bfseries\large Total:} & \bfseries\large\num{#2}~\euro \\
}

% ============================================================================
% CUADRO DE PRECIOS - Estilo profesional sin caja
% ============================================================================

% Cuadro de precios descompuestos (sin caja, estilo libro de precios)
% Uso: \begin{cuadroprecios}[Título opcional]
%        \unidadobra{Código}{Descripción}{Unidad}{Rendimiento}{Precio}
%      \end{cuadroprecios}
\newenvironment{cuadroprecios}[1][Cuadro de precios descompuestos]{%
  \begingroup
  \small
  \subsection*{{\footnotesize\faList}~#1}
  \vspace{-0.5em}
  \begin{longtable}{@{}p{1.2cm}p{6.5cm}crrr@{}}
    \toprule
    \textbf{Código} & \textbf{Descripción} & \textbf{Ud.} & \textbf{Rend.} & \textbf{P.Unit.} & \textbf{Importe} \\
    \midrule
    \endhead
    \midrule
    \multicolumn{6}{r}{\footnotesize\emph{Continúa...}} \\
    \endfoot
    \bottomrule
    \endlastfoot
}{%
  \end{longtable}
  \endgroup
}

% Unidad de obra (fila para cuadroprecios)
% Uso: \unidadobra{Código}{Descripción}{Unidad}{Rendimiento}{Precio}
\newcommand{\unidadobra}[5]{%
  \texttt{#1} & #2 & #3 & \num{#4} & \num{#5}~\euro & \num[round-mode=places,round-precision=2]{\fpeval{#4*#5}}~\euro \\
}

% Subtotal de partida
\newcommand{\preciosubtotal}[2]{%
  \midrule
  \multicolumn{5}{r}{\textbf{#1}} & \textbf{\num{#2}~\euro} \\
}

% Separador de capítulo en cuadro de precios
\newcommand{\preciocapitulo}[1]{%
  \midrule
  \multicolumn{6}{@{}l}{\bfseries\textcolor{eps-primary}{#1}} \\
  \midrule
}

% ============================================================================
% NORMATIVA - Lista de referencias normativas estilo profesional
% ============================================================================

% Lista de normativa (sin caja, estilo bibliografía)
% Uso: \begin{normativa}[título]
%        \norma{CTE DB-SE}{Seguridad estructural}{2019}
%      \end{normativa}
\newenvironment{normativa}[1][Normativa aplicable]{%
  \begingroup
  \small
  \subsection*{#1}
  \begin{description}[style=nextline, leftmargin=3cm, labelwidth=2.8cm]
}{%
  \end{description}
  \endgroup
}

% Referencia normativa con descripción
\newcommand{\norma}[3]{%
  \item[\textbf{#1} \hfill \textcolor{eps-gray}{(#3)}] #2
}

% Referencia normativa con estado (vigente/derogada)
\newcommand{\normavigente}[3]{%
  \item[\textbf{#1} \hfill \textcolor{eps-success}{\faCheck}] #2 \hfill \textcolor{eps-gray}{#3}
}

\newcommand{\normaderogada}[3]{%
  \item[\textbf{#1} \hfill \textcolor{eps-danger}{\faTimes}] \sout{#2} \hfill \textcolor{eps-gray}{#3 -- Derogada}
}

% ============================================================================
% LEYENDA DE PLANOS - Grid visual de símbolos
% ============================================================================

% Leyenda visual (grid de símbolos y descripciones)
% Uso: \begin{leyenda}[columnas]
%        \legenditem{\simboloagua}{Fontanería}
%      \end{leyenda}
\newenvironment{leyenda}[1][2]{%
  \begingroup
  \small
  \begin{center}
  \begin{tabular}{*{#1}{@{}c@{\quad}l@{\qquad}}}
}{%
  \end{tabular}
  \end{center}
  \endgroup
}

% Item de leyenda
\newcommand{\legenditem}[2]{%
  #1 & #2
}

% Símbolo de leyenda (alias para compatibilidad)
\newcommand{\simbolo}[2]{%
  #1 & #2
}

% Símbolos predefinidos para construcción
\newcommand{\simboloagua}{\textcolor{eps-info}{\faWater}}
\newcommand{\simbologas}{\textcolor{eps-warning}{\faFire}}
\newcommand{\simboloelec}{\textcolor{eps-danger}{\faBolt}}
\newcommand{\simbolotele}{\textcolor{eps-success}{\faPhone}}
\newcommand{\simboloclima}{\textcolor{eps-accent}{\faSnowflake}}
\newcommand{\simbolosanea}{\textcolor{eps-secondary}{\faToilet}}

% ============================================================================
% DETALLE CONSTRUCTIVO
% ============================================================================

% Detalle constructivo (sin caja, centrado)
% Uso: \begin{detalleconstructivo}[Encuentro forjado-fachada]
%        \begin{tikzpicture}...
%      \end{detalleconstructivo}
\newenvironment{detalleconstructivo}[1][Detalle constructivo]{%
  \begin{center}
  {\small\bfseries\faRulerCombined\hspace{0.5em}#1}
  \par\vspace{4pt}
}{%
  \end{center}
}

% Cota
\newcommand{\cota}[1]{%
  \begin{tikzpicture}[baseline=-0.3em]
    \draw[<->, eps-dark, thick] (0,0) -- (1,0);
    \node[above, font=\footnotesize] at (0.5,0) {#1};
  \end{tikzpicture}
}

% Escala
\newcommand{\escala}[1]{%
  \textbf{Escala:} 1:#1
}

% ============================================================================
% CERTIFICACIONES Y CALIDAD
% ============================================================================

% Sello de certificación
\newcommand{\certificacion}[2]{%
  \begin{tikzpicture}[baseline=-0.3em]
    \node[draw=eps-success, fill=eps-success!10, rounded corners=4pt,
          inner sep=4pt, font=\footnotesize] {
      \textcolor{eps-success}{\faCheckCircle}~\textbf{#1}~|~#2
    };
  \end{tikzpicture}
}

% Lista de certificaciones
\newcommand{\certiso}[1]{\certificacion{ISO #1}{Certificado}}
\newcommand{\certce}{\certificacion{CE}{Marcado CE}}
\newcommand{\certune}[1]{\certificacion{UNE #1}{Norma española}}

% ============================================================================
% SOSTENIBILIDAD Y EFICIENCIA
% ============================================================================

% Etiqueta energética
\newcommand{\etiquetaenergetica}[1]{%
  \begin{tikzpicture}[baseline=-0.3em]
    \ifstrequal{#1}{A}{\def\@eecolor{green!70!black}}{}
    \ifstrequal{#1}{B}{\def\@eecolor{green!50!black}}{}
    \ifstrequal{#1}{C}{\def\@eecolor{yellow!70!black}}{}
    \ifstrequal{#1}{D}{\def\@eecolor{orange}}{}
    \ifstrequal{#1}{E}{\def\@eecolor{orange!70!red}}{}
    \ifstrequal{#1}{F}{\def\@eecolor{red!70!orange}}{}
    \ifstrequal{#1}{G}{\def\@eecolor{red}}{}
    \node[fill=\@eecolor, text=white, font=\bfseries\footnotesize,
          minimum width=1.5cm, minimum height=0.6cm, inner sep=2pt] {#1};
    \draw[fill=\@eecolor] (0.75,0) -- (1.1,0.15) -- (1.1,-0.15) -- cycle;
  \end{tikzpicture}
}

% Indicadores de sostenibilidad
\newcommand{\sostenibilidad}[2]{%
  \noindent
  \begin{minipage}[t]{0.3\textwidth}
    #1
  \end{minipage}%
  \begin{minipage}[t]{0.65\textwidth}
    \progressbar{#2}
  \end{minipage}
  \vspace{4pt}
}

% ============================================================================
% ORGANIGRAMA DE OBRA
% ============================================================================

% Estilos para organigrama
\tikzset{
  orgnode/.style={
    rectangle, rounded corners=4pt,
    draw=eps-primary, fill=eps-primary!10,
    minimum width=2.5cm, minimum height=0.8cm,
    font=\footnotesize, align=center,
  },
  orgmanager/.style={
    orgnode, fill=eps-primary!30, font=\footnotesize\bfseries,
  },
  orgline/.style={
    thick, eps-gray,
  },
}

% Organigrama de obra (sin caja, centrado)
% Uso: \begin{organigramabox}[Organigrama del proyecto X]
%        \begin{tikzpicture}...
%      \end{organigramabox}
\newenvironment{organigramabox}[1][Organigrama de obra]{%
  \begin{center}
  {\small\bfseries\faSitemap\hspace{0.5em}#1}
  \par\vspace{4pt}
}{%
  \end{center}
}

% ============================================================================
% CONTROL DE CALIDAD - Estilo profesional
% ============================================================================

% Tabla de control de calidad (sin caja)
% Uso: \begin{controlcalidad}
%        \controlitem{Resistencia hormigón}{32.5 MPa}{≥25 MPa}{OK}
%      \end{controlcalidad}
\newenvironment{controlcalidad}[1][Control de calidad]{%
  \begingroup
  \small
  \subsection*{#1}
  \begin{tabular}{@{}p{5cm}ccl@{}}
    \toprule
    \textbf{Ensayo/Control} & \textbf{Resultado} & \textbf{Límite} & \textbf{Estado} \\
    \midrule
}{%
    \bottomrule
  \end{tabular}
  \endgroup
}

\newcommand{\controlitem}[4]{%
  #1 & #2 & #3 & 
  \ifstrequal{#4}{OK}{\textcolor{eps-success}{\faCheck}~Conforme}{}%
  \ifstrequal{#4}{NO}{\textcolor{eps-danger}{\faTimes}~No conforme}{}%
  \ifstrequal{#4}{PEND}{\textcolor{eps-warning}{\faClock}~Pendiente}{}%
  \\
}

% Indicadores rápidos
\newcommand{\controlok}{\textcolor{eps-success}{\faCheck}}
\newcommand{\controlno}{\textcolor{eps-danger}{\faTimes}}
\newcommand{\controlpend}{\textcolor{eps-warning}{\faClock}}

% ============================================================================
% SUPERFICIES Y CUADROS - Estilo profesional
% ============================================================================

% Cuadro de superficies estilo booktabs
% Uso: \begin{cuadrosuperficies}
%        \superficie{Salón-comedor}{25.50}{28.30}
%        \superficietotal{Total planta baja}{85.20}{102.45}
%      \end{cuadrosuperficies}
\newenvironment{cuadrosuperficies}[1][Cuadro de superficies]{%
  \begingroup
  \small
  \subsection*{#1}
  \begin{tabular}{@{}p{5cm}rr@{}}
    \toprule
    \textbf{Estancia/Zona} & \textbf{Sup. útil (m²)} & \textbf{Sup. construida (m²)} \\
    \midrule
}{%
    \bottomrule
  \end{tabular}
  \endgroup
}

\newcommand{\superficie}[3]{%
  #1 & \num{#2} & \num{#3} \\
}

% Superficie con nivel de planta
\newcommand{\superficieplanta}[1]{%
  \midrule
  \multicolumn{3}{@{}l}{\bfseries\textcolor{eps-primary}{#1}} \\
  \midrule
}

% Total de superficies
\newcommand{\superficietotal}[3]{%
  \midrule
  \textbf{#1} & \textbf{\num{#2}} & \textbf{\num{#3}} \\
}

% Subtotal por planta
\newcommand{\superficiesubtotal}[2]{%
  \emph{Subtotal} & \emph{\num{#1}} & \emph{\num{#2}} \\
}

% Compatibilidad con totalsuperficie anterior
\newcommand{\totalsuperficie}[2]{%
  \midrule
  \textbf{TOTAL} & \textbf{\num{#1}} & \textbf{\num{#2}} \\
}

\endinput
