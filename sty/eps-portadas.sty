%% eps-portadas.sty
%% Paquete de portadas para TFG/TFM EPS Universidad de Alicante
%%
%% Proyecto: Plantilla TFG/TFM EPS Universidad de Alicante
%% Autor:    José Manuel Requena Plens
%% Enlace:   https://github.com/jmrplens/TFG-TFM_EPS
%% Licencia: GNU GPL v3.0
%% Versión:  2.1.0 (2026/02/05)
%%
\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{eps-portadas}[2026/02/05 v2.1.0 Portadas TFG/TFM EPS UA]

\RequirePackage{xparse}
\RequirePackage{tikz}
\RequirePackage{tikzpagenodes}
\RequirePackage{textpos}
\RequirePackage{setspace}
\RequirePackage{xstring}
\RequirePackage{geometry}
\RequirePackage{tcolorbox}
\tcbuselibrary{fitting,skins}

%% ============================================================================
%% VARIABLES PARA PORTADAS
%% ============================================================================

% Tamaños por defecto
\newcommand{\eps@FuenteTamano}{55pt}
\newcommand{\eps@interlinportada}{5.0}
\newcommand{\eps@TamTrabajo}{20pt}
\newcommand{\eps@TamTrabajoIn}{20pt}
\newcommand{\eps@TamOtros}{12pt}
\newcommand{\eps@TamOtrosIn}{1pt}

%% ============================================================================
%% PORTADA A COLOR
%% ============================================================================
\NewDocumentCommand{\portadacolor}{}{%
  %
  % Restaurar márgenes "normales" pero ignorar cabeceras/pies para la portada
  % Esto asegura que el "current page" de PGF coincida con lo esperado por TikZ
  \newgeometry{ignoreall, top=2cm, outer=2cm, inner=2cm, bottom=2cm}%
  %
  % Desactivar externalización TikZ si está activa
  \ifdefined\tikzexternaldisable\tikzexternaldisable\fi
  %
  \begin{titlepage}
    \thispagestyle{empty}%
    %
    % === CAPA ÚNICA CON TIKZ ===
    \begin{tikzpicture}[remember picture, overlay]
      % 1. Fondo del color del grado (toda la página)
      % Sangrado de 1pt para evitar líneas blancas en visualizadores
      \fill[\EPScolorGrado] ([xshift=-1pt,yshift=-1pt]current page.south west) rectangle ([xshift=1pt,yshift=1pt]current page.north east);
      
      % 2. Franja negra inferior
      \fill[black] ([xshift=-1pt,yshift=-1pt]current page.south west) rectangle ([xshift=1pt,yshift=6.86cm]current page.south east);
      
      % 3. Logo de la facultad (Arriba Derecha)
      \node[anchor=north east, inner sep=0pt] 
        at ([xshift=-1.5cm, yshift=-1.4cm]current page.north east)
        {\includegraphics[width=5.3cm]{\EPSlogoFacultadPortada}};
      
      % 4. Logo de la universidad (Abajo Derecha - En franja negra)
      \node[anchor=south east, inner sep=0pt] 
        at ([xshift=-1.5cm, yshift=1.6cm]current page.south east)
        {\includegraphics[width=6.2cm]{\EPSlogoUniversidadPortada}};

      % 5. Título (Caja auto-ajustable con tcolorbox)
      \node[anchor=north west, inner sep=0pt] 
         at ([xshift=2cm, yshift=0cm]current page.north west) {%
         \begin{minipage}[t][18cm][b]{18cm} % Altura total hasta donde queremos que acabe el titulo
          \null\vfill
          \tcboxfit[%
            enhanced,
            frame empty,
            interior empty,
            width=18cm,
            height=9cm, % Altura maxima del titulo
            halign=flush left,
            valign=bottom, 
            nobeforeafter,
            coltext=\EPScolorTexto,
            fontupper=\FuenteTitulo\bfseries,
            fit basedim=55pt,
            fit skip=1.3,
          ]{\EPStitulo}
         \end{minipage}
      };

      % 6. Información Grado (Logo + Texto)
      % Posicionado debajo del título.
      % Restaurado: Posición original relativa a la franja negra o fija
      \node[anchor=north west, inner sep=0pt] 
        at ([xshift=3cm, yshift=-13.5cm]current page.north west) {%
        \begin{tabular}{lL{12cm}}
          \raisebox{-.35\height}{\includegraphics[width=2cm]{\EPSlogoGradoPortada}} & 
          \begin{spacing}{1.5}
            {\raggedleft{\FuentePortada\fontsize{20pt}{40pt}\selectfont\color{\EPScolorTexto}\EPStitulacion}}
          \end{spacing}\\
        \end{tabular}%
      };

      % 7. Metadatos (Autor, Tutor, etc. en franja negra)
      % Alineado a la izquierda (offset 2.5cm del borde izquierdo)
      % (Bajado ~0.5cm para evitar que toque el borde superior de la franja o el logo)
      \node[anchor=north west, inner sep=0pt] 
        at ([xshift=2cm, yshift=6.3cm]current page.south west) {%
        \begin{minipage}{15cm}
          \color{white}
          {\FuentePortada\fontsize{\eps@TamTrabajo}{45pt}\selectfont\EPStipoTrabajo}\\[\eps@TamTrabajoIn]
          {\FuentePortada\fontsize{\eps@TamOtros}{30pt}\selectfont\EPSetiquetaAutor:}\\[\eps@TamOtrosIn]
          {\FuentePortada\fontsize{\eps@TamOtros}{50pt}\selectfont\EPSautor}\\[\eps@TamOtrosIn]
          {\FuentePortada\fontsize{\eps@TamOtros}{30pt}\selectfont\EPSetiquetaTutor:}\\[\eps@TamOtrosIn]
          {\FuentePortada\fontsize{\eps@TamOtros}{30pt}\selectfont\EPStutor}\\[\eps@TamOtrosIn]
          \EPSsiCotutor{{\FuentePortada\fontsize{\eps@TamOtros}{30pt}\selectfont\EPScotutor}\\[\eps@TamOtrosIn]}{}%
          \\[\eps@TamOtrosIn]
          {\FuentePortada\fontsize{\eps@TamOtros}{30pt}\selectfont\EPSfecha}
        \end{minipage}%
      };

    \end{tikzpicture}
  \end{titlepage}
  %
  % Restaurar geometría
  \restoregeometry
  %
  % Reactivar externalización TikZ
  \ifdefined\tikzexternalenable\tikzexternalenable\fi
}

%% ============================================================================
%% PORTADA EN BLANCO Y NEGRO
%% ============================================================================
\NewDocumentCommand{\portadabn}{}{%
  \begin{titlepage}
    % Márgenes de esta página: Simétricos para centrado correcto
    \newgeometry{left=2.5cm,right=2.5cm,top=2.5cm,bottom=2.5cm}%
    \thispagestyle{empty}%
    %
    % Título y subtítulo
    \begin{minipage}{\textwidth}
      \centering
      \begin{spacing}{1.5}
        {\huge\bfseries\EPStitulo}
      \end{spacing}
      \noindent\rule[-1ex]{\textwidth}{3pt}\\[3.5ex]
      {\large\bfseries\EPSsubtitulo\\[4cm]}
    \end{minipage}

    % Relleno hasta zona central
    \vspace{2.5cm}

    % Autor y Tutores
    \begin{minipage}{\textwidth}
      \centering
      \textbf{\EPSetiquetaAutor}\\
      {\EPSautor}\\[2.5ex]
      \textbf{\EPSetiquetaTutor}\\
      {\normalsize\EPStutor\\
        \ifx\EPStutorDpto\empty\else\small\textit{\EPStutorDpto}\\\fi
        \EPSsiCotutor{%
          \normalsize\EPScotutor\\
          \ifx\EPScotutorDpto\empty\else\small\textit{\EPScotutorDpto}\\\fi
        }{}%
      }
    \end{minipage}

    % Relleno hasta zona inferior (IMPORTANTE: fuera del minipage)
    \vspace*{\fill}

    % Logos y fecha
    \begin{minipage}{\textwidth}
      \centering
      \begin{center}
        \includegraphics[width=3cm]{\EPSlogoGrado}\\
        {\raggedleft\EPStitulacion}
      \end{center}
      \vspace*{2em}
      \centering
      \begin{minipage}[c]{6cm}
        \includegraphics[width=5cm]{\EPSlogoFacultad}
      \end{minipage}
      \begin{minipage}[r]{6cm}
        \includegraphics[width=5cm]{\EPSlogoUniversidad}
      \end{minipage}
      \\[1cm]
      \MakeUppercase{\EPSubicacion}, \EPSfecha
    \end{minipage}
  \end{titlepage}
  %
  % Restaurar geometría
  \restoregeometry
}

%% ============================================================================
%% COMANDO UNIFICADO PARA GENERAR PORTADAS
%% ============================================================================
\newif\ifeps@portadacolor
\newif\ifeps@portadabn

\pgfkeys{
  /eps/portada/.cd,
  color/.is if=eps@portadacolor,
  color/.default=true,
  bn/.is if=eps@portadabn,
  bn/.default=true,
  blanco-negro/.is if=eps@portadabn,
  ambas/.style={color=true,bn=true},
  solo-color/.style={color=true,bn=false},
  solo-bn/.style={color=false,bn=true},
}

\NewDocumentCommand{\generarportada}{O{ambas}}{%
  \eps@portadacolorfalse
  \eps@portadabnfalse
  \pgfkeys{/eps/portada/.cd,#1}%
  \ifeps@portadacolor
    \portadacolor
  \fi
  \ifeps@portadabn
    \portadabn
  \fi
}

%% ============================================================================
%% ALIAS PARA COMPATIBILIDAD
%% ============================================================================
\let\portada\generarportada

\endinput
