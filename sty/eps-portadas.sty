%% eps-portadas.sty
%% Paquete de portadas para TFG/TFM EPS Universidad de Alicante
%%
%% Versión 3.0 - Refactorizado con posicionamiento absoluto por conjuntos
%%
\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{eps-portadas}[2026/02/05 v3.0 Portadas TFG/TFM EPS UA]

\RequirePackage{xparse}
\RequirePackage{tikz}
\RequirePackage{tikzpagenodes}
\RequirePackage{textpos}
\RequirePackage{setspace}
\RequirePackage{xstring}
\RequirePackage{geometry}
\RequirePackage{afterpage} 
% Necesario para \pagecolor
\RequirePackage{xcolor} 

%% ============================================================================
%% VARIABLES CONFIGURABLES DE PORTADA COLOR
%% ============================================================================

% --- ELEMENTO 1: Logotipo Esquina Superior Derecha (Facultad) ---
% Coordenadas relativas a la esquina SUPERIOR DERECHA (north east)
\newcommand{\eps@portadaLogoTRX}{-2.1cm} % Desplazamiento horizontal (hacia izquierda)
\newcommand{\eps@portadaLogoTRY}{-1.5cm} % Desplazamiento vertical (hacia abajo)
\newcommand{\eps@portadaLogoTRWidth}{5.25cm} % Ancho del logo

% --- ELEMENTO 4: Logotipo Esquina Inferior Derecha (Universidad) ---
% Coordenadas relativas a la esquina INFERIOR DERECHA (south east)
\newcommand{\eps@portadaLogoBRX}{-1.5cm} % Desplazamiento horizontal (hacia izquierda)
\newcommand{\eps@portadaLogoBRY}{1.6cm}  % Desplazamiento vertical (hacia arriba)
\newcommand{\eps@portadaLogoBRWidth}{6.2cm} % Ancho del logo

% --- FRANJA NEGRA ---
\newcommand{\eps@portadaStripHeight}{7cm}

% --- CONJUNTO A: Título y Titulación ---
% 1. Logo + Nombre Titulación
\newcommand{\eps@portadaInfoGradoX}{2.55cm} % Desde izquierda
\newcommand{\eps@portadaInfoGradoY}{13.4cm} % Desde abajo (Posición fija)
\newcommand{\eps@portadaInfoGradoLogoHeight}{2cm} % Altura del logo titulación

% 2. Título del Trabajo
\newcommand{\eps@portadaTituloX}{2.1cm}    % Desde izquierda
\newcommand{\eps@portadaTituloY}{16.2cm} % Desde abajo (Punto inferior del bloque texto)
\newcommand{\eps@portadaTituloWidth}{17cm} % Ancho máximo del texto

% --- CONJUNTO B: Info Personal, Tipo, Tutor, Fecha ---
% Origen del Conjunto B (Esquina Inferior Izquierda de referencia de la PAGINA)
\newcommand{\eps@portadaSetBX}{2.4cm}
\newcommand{\eps@portadaSetBY}{0cm} % Base en borde inferior (0cm) para calcular respecto a franja

% --- POSICIONES ABSOLUTAS DENTRO DE LA FRANJA (0 a 7cm) ---
% 1. Tipo de Trabajo: Arriba del todo (Y Max)
\newcommand{\eps@portadaOffsetTipo}{6cm} 
% 4. Fecha: Abajo del todo (Y Min)
\newcommand{\eps@portadaOffsetFecha}{1cm}

% 2 y 3. Autor y Tutor: Distribuidos en medio
% Espacio disponible entre tipo y fecha: 6.25 - 0.75 = 5.5cm aprox.
% Asignamos posiciones fijas razonables:
\newcommand{\eps@portadaOffsetAutor}{4.4cm}
\newcommand{\eps@portadaOffsetTutor}{2.8cm}

% --- TAMAÑOS DE FUENTE ---
\newcommand{\eps@sizeTitulo}{55pt}
\newcommand{\eps@sizeGrado}{20pt}
\newcommand{\eps@sizeTipoTrabajo}{20pt}
\newcommand{\eps@sizeInfo}{12pt}

% Factores de interlineado (multiplicador del tamaño de fuente)
% Ejemplo: 1.2 significa 1.2 * TamañoFuente
\newcommand{\eps@leadingTitulo}{1.2}
\newcommand{\eps@leadingGrado}{1.1}
\newcommand{\eps@leadingInfo}{1.2}
\newcommand{\eps@portadaGapGrado}{0.55cm}

% --- ESTILOS DE FUENTE REUTILIZABLES (Solo fuente, sin color) ---
% Modificado para aplicar interlineado directamente en \fontsize
\newcommand{\eps@FuenteInfo}{%
  \FuentePortada\fontsize{\eps@sizeInfo}{\dimexpr\eps@leadingInfo\dimexpr\eps@sizeInfo\relax\relax}\selectfont
}
\newcommand{\eps@FuenteTituloStyle}{%
  \FuenteTitulo\fontsize{\eps@sizeTitulo}{\dimexpr\eps@leadingTitulo\dimexpr\eps@sizeTitulo\relax\relax}\selectfont
}
\newcommand{\eps@FuenteTipoTrabajo}{%
  \FuentePortada\fontsize{\eps@sizeTipoTrabajo}{\dimexpr1.2\dimexpr\eps@sizeTipoTrabajo\relax\relax}\selectfont
}

%% ============================================================================
%% PORTADA A COLOR DEFINITIVA
%% ============================================================================
\NewDocumentCommand{\portadacolor}{}{%
  % Configuración de página limpia
  \newgeometry{ignoreall,top=0cm,bottom=0cm,outer=0cm,inner=0cm}
  
  \ifdefined\tikzexternaldisable\tikzexternaldisable\fi
  \thispagestyle{empty}

  % 1. COLOR DE FONDO (Directo a página, sin tikz si es posible)
  % Usamos \pagecolor para el fondo
  \pagecolor{\EPScolorGrado}

  \begin{tikzpicture}[remember picture, overlay]

    % -------------------------------------------------------------------------
    % FRANJA NEGRA (Elemento TikZ inevitable para superponer)
    % -------------------------------------------------------------------------
    \fill[black] (current page.south west) rectangle ([yshift=\eps@portadaStripHeight]current page.south east);

    % -------------------------------------------------------------------------
    % ELEMENTO 1: LOGO SUPERIOR DERECHA (Facultad)
    % -------------------------------------------------------------------------
    \node[anchor=north east, inner sep=0pt] 
       at ([xshift=\eps@portadaLogoTRX, yshift=\eps@portadaLogoTRY]current page.north east)
       {\includegraphics[width=\eps@portadaLogoTRWidth]{\EPSlogoFacultadPortada}};

    % -------------------------------------------------------------------------
    % ELEMENTO 4: LOGO INFERIOR DERECHA (Universidad)
    % -------------------------------------------------------------------------
    \node[anchor=south east, inner sep=0pt] 
       at ([xshift=\eps@portadaLogoBRX, yshift=\eps@portadaLogoBRY]current page.south east)
       {\includegraphics[width=\eps@portadaLogoBRWidth]{\EPSlogoUniversidadPortada}};

    % -------------------------------------------------------------------------
    % CONJUNTO A: TÍTULO + TITULACIÓN
    % -------------------------------------------------------------------------
    
    % A.1 Título (Anclado South-West, crece hacia arriba)
    \node[anchor=south west, inner sep=0, align=flush left, text width=\eps@portadaTituloWidth, font=\eps@FuenteTituloStyle] 
       at ([xshift=\eps@portadaTituloX, yshift=\eps@portadaTituloY]current page.south west)
       {%
         \color{\EPScolorTexto}
         \EPStitulo
       };

    % A.2 Info Grado (Logo + Texto)
    % Refactorizado a dos nodos TikZ independientes para asegurar alineación vertical
    % centrada perfecta entre el logo y el bloque de texto (evita problemas de leading).
    
    % 1. Nodo del Logo
    \node[anchor=south west, inner sep=0] (InfoGradoLogo)
       at ([xshift=\eps@portadaInfoGradoX, yshift=\eps@portadaInfoGradoY]current page.south west)
       {\includegraphics[height=\eps@portadaInfoGradoLogoHeight]{\EPSlogoGradoPortada}};

    % 2. Nodo del Texto (Anclado al centro vertical derecho del logo)
    \node[anchor=west, inner sep=0, text width=13cm, align=flush left]
       at ([xshift=\eps@portadaGapGrado]InfoGradoLogo.east)
       {%
           \color{\EPScolorTexto}
           \FuentePortada\fontsize{\eps@sizeGrado}{\dimexpr\eps@leadingGrado\dimexpr\eps@sizeGrado\relax\relax}\selectfont
           \EPStitulacion
       };

    % -------------------------------------------------------------------------
    % CONJUNTO B: INFO PERSONAL
    % -------------------------------------------------------------------------
    % Definimos el origen del Conjunto B
    \coordinate (SetBOrigin) at ([xshift=\eps@portadaSetBX, yshift=\eps@portadaSetBY]current page.south west);

    % B.1 Tipo de Trabajo (Top Anchor - North West)
    \node[anchor=north west, inner sep=0, font=\eps@FuenteTipoTrabajo, text=white] 
        at ([yshift=\eps@portadaOffsetTipo]SetBOrigin)
        {%
          \EPStipoTrabajo
        };

    % B.2 Autor (Bloque etiqueta + nombre)
    \node[anchor=north west, inner sep=0, align=left, text=white, font=\eps@FuenteInfo] 
        at ([yshift=\eps@portadaOffsetAutor]SetBOrigin)
        {%
          \EPSetiquetaAutor: \\
          \EPSautor
        };

    % B.3 Tutor (Bloque etiqueta + nombre/s). 
    \node[anchor=north west, inner sep=0, align=left, text=white, font=\eps@FuenteInfo] 
        at ([yshift=\eps@portadaOffsetTutor]SetBOrigin)
        {%
          \EPSetiquetaTutor: \\
          \EPStutor
          \EPSsiCotutor{\\ 
            Cotutor/a:\\ 
            \EPScotutor
          }{}
        };

    % B.4 Fecha (Bottom Anchor - South West)
    \node[anchor=south west, inner sep=0, font=\eps@FuenteInfo, text=white] 
        at ([yshift=\eps@portadaOffsetFecha]SetBOrigin)
        {%
           \EPSfecha
        };

  \end{tikzpicture}
  
  \newpage
  \nopagecolor % Restaurar fondo blanco para siguiente página
  \restoregeometry
}

\endinput
