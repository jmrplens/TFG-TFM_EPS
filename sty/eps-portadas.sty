%% eps-portadas.sty
%% Paquete de generación de portadas para TFG/TFM EPS (UA)
%%
%% Proyecto: Plantilla TFG/TFM EPS Universidad de Alicante
%% Autor:    José Manuel Requena Plens
%% Enlace:   https://github.com/jmrplens/TFG-TFM_EPS
%% Licencia: GNU GPL v3.0
%% Versión:  2.1.0 (2026/02/05)
%%
%% -----------------------------------------------------------------------------
\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{eps-portadas}[2026/02/05 v2.1.0 Portadas TFG/TFM EPS Universidad de Alicante]

\RequirePackage{xparse}
\RequirePackage{tikz}
\RequirePackage{tikzpagenodes}
\RequirePackage{textpos}
\RequirePackage{setspace}
\RequirePackage{xstring}
\RequirePackage{geometry}
\RequirePackage{afterpage} 
% Necesario para \pagecolor
\RequirePackage{xcolor} 
\RequirePackage{fontspec}

%% ============================================================================
%% DEFINICIÓN DE FUENTES DE PORTADA
%% ============================================================================

% Fuente condensada para títulos (Helvetica Condensed)
\IfFileExists{recursos/fuentes/HelveticaLTStd-Cond.otf}{%
  \newfontfamily\FuenteTitulo{HelveticaLTStd-Cond.otf}[%
    Path = recursos/fuentes/%
  ]%
}{%
  % Fallback: HelveticaNeue del sistema
  \IfFontExistsTF{HelveticaNeue-CondensedBold}{%
    \newfontfamily\FuenteTitulo{HelveticaNeue-CondensedBold}%
  }{%
    % Fallback: Arial Narrow
    \IfFontExistsTF{Arial Narrow}{%
      \newfontfamily\FuenteTitulo{Arial Narrow}[BoldFont=* Bold]%
    }{%
      % Fallback definitivo
      \newcommand{\FuenteTitulo}{\sffamily\bfseries}%
    }%
  }%
}

% Fuente principal para portada (Helvetica)
\IfFileExists{recursos/fuentes/Helvetica.ttf}{%
  \newfontfamily\FuentePortada{Helvetica.ttf}[%
    Path = recursos/fuentes/%
  ]%
}{%
  % Fallback: Helvetica del sistema
  \IfFontExistsTF{Helvetica}{%
    \newfontfamily\FuentePortada{Helvetica}%
  }{%
    % Fallback: Arial
    \IfFontExistsTF{Arial}{%
      \newfontfamily\FuentePortada{Arial}%
    }{%
      % Fallback: DejaVu Sans
      \IfFontExistsTF{DejaVu Sans}{%
        \newfontfamily\FuentePortada{DejaVu Sans}%
      }{%
        \newcommand{\FuentePortada}{\sffamily}%
      }%
    }%
  }%
} 

%% ============================================================================
%% VARIABLES CONFIGURABLES DE PORTADA COLOR
%% ============================================================================

% --- ELEMENTO 1: Logotipo Esquina Superior Derecha (Facultad) ---
% Coordenadas relativas a la esquina SUPERIOR DERECHA (north east)
\newcommand{\eps@portadaLogoTRX}{-2.1cm} % Desplazamiento horizontal (hacia izquierda)
\newcommand{\eps@portadaLogoTRY}{-1.5cm} % Desplazamiento vertical (hacia abajo)
\newcommand{\eps@portadaLogoTRWidth}{5.25cm} % Ancho del logo

% --- ELEMENTO 4: Logotipo Esquina Inferior Derecha (Universidad) ---
% Coordenadas relativas a la esquina INFERIOR DERECHA (south east)
\newcommand{\eps@portadaLogoBRX}{-1.5cm} % Desplazamiento horizontal (hacia izquierda)
\newcommand{\eps@portadaLogoBRY}{1.6cm}  % Desplazamiento vertical (hacia arriba)
\newcommand{\eps@portadaLogoBRWidth}{6.2cm} % Ancho del logo

% --- FRANJA NEGRA ---
\newcommand{\eps@portadaStripHeight}{7cm}

% --- CONJUNTO A: Título y Titulación ---
% 1. Logo + Nombre Titulación
\newcommand{\eps@portadaInfoGradoX}{2.55cm} % Desde izquierda
\newcommand{\eps@portadaInfoGradoY}{13.4cm} % Desde abajo (Posición fija)
\newcommand{\eps@portadaInfoGradoLogoHeight}{2cm} % Altura del logo titulación

% 2. Título del Trabajo
\newcommand{\eps@portadaTituloX}{2.1cm}    % Desde izquierda
\newcommand{\eps@portadaTituloY}{16.2cm} % Desde abajo (Punto inferior del bloque texto)
\newcommand{\eps@portadaTituloWidth}{17cm} % Ancho máximo del texto

% --- CONJUNTO B: Info Personal, Tipo, Tutor, Fecha ---
% Origen del Conjunto B (Esquina Inferior Izquierda de referencia de la PAGINA)
\newcommand{\eps@portadaSetBX}{2.4cm}
\newcommand{\eps@portadaSetBY}{0cm} % Base en borde inferior (0cm) para calcular respecto a franja

% --- POSICIONES ABSOLUTAS DENTRO DE LA FRANJA (0 a 7cm) ---
% 1. Tipo de Trabajo: Arriba del todo (Y Max)
\newcommand{\eps@portadaOffsetTipo}{6cm} 
% 4. Fecha: Abajo del todo (Y Min)
\newcommand{\eps@portadaOffsetFecha}{1cm}

% 2 y 3. Autor y Tutor: Distribuidos en medio
% Estos valores son los predeterminados para el caso de 1 solo tutor.
% NOTA: Estas variables se redefinen dentro de \portadacolor si hay cotutor.
\newcommand{\eps@portadaOffsetAutor}{4.4cm}
\newcommand{\eps@portadaOffsetTutor}{2.8cm}

% --- TAMAÑOS DE FUENTE ---
\newcommand{\eps@sizeTitulo}{55pt}
\newcommand{\eps@sizeGrado}{20pt}
\newcommand{\eps@sizeTipoTrabajo}{20pt}
\newcommand{\eps@sizeInfo}{12pt}

% Factores de interlineado (multiplicador del tamaño de fuente)
% Ejemplo: 1.2 significa 1.2 * TamañoFuente
\newcommand{\eps@leadingTitulo}{1.2}
\newcommand{\eps@leadingGrado}{1.1}
\newcommand{\eps@leadingInfo}{1.2}
\newcommand{\eps@portadaGapGrado}{0.55cm}

% --- ESTILOS DE FUENTE REUTILIZABLES ---
% Definición de estilo con tamaño e interlineado explícito
\newcommand{\eps@FuenteInfo}{%
  \FuentePortada\fontsize{\eps@sizeInfo}{\dimexpr\eps@leadingInfo\dimexpr\eps@sizeInfo\relax\relax}\selectfont
}
\newcommand{\eps@FuenteTituloStyle}{%
  \FuenteTitulo\fontsize{\eps@sizeTitulo}{\dimexpr\eps@leadingTitulo\dimexpr\eps@sizeTitulo\relax\relax}\selectfont
}
\newcommand{\eps@FuenteTipoTrabajo}{%
  \FuentePortada\fontsize{\eps@sizeTipoTrabajo}{\dimexpr1.2\dimexpr\eps@sizeTipoTrabajo\relax\relax}\selectfont
}

% --- LÓGICA DE ESCALADO AUTOMÁTICO DEL TÍTULO ---
\newlength{\eps@titleAvailableH}
\newlength{\eps@titleContentH}
\newlength{\eps@logoH}
\newsavebox{\eps@logoBox}
\newsavebox{\eps@titleBox}

\newcommand{\eps@optimizeTitleSize}{%
  % 1. Medir la altura real del logo superior derecho
  \savebox{\eps@logoBox}{\includegraphics[width=\eps@portadaLogoTRWidth]{\EPSlogoFacultadPortada}}%
  \setlength{\eps@logoH}{\ht\eps@logoBox + \dp\eps@logoBox}%
  
  % 2. Calcular espacio vertical disponible
  % Altura Página (29.7cm) + OffsetY (negativo) - AlturaLogo - OrigenTitulo (16.2cm) - Margen seguridad (0.5cm)
  \setlength{\eps@titleAvailableH}{29.7cm}%
  \addtolength{\eps@titleAvailableH}{\eps@portadaLogoTRY}% Resta el margen superior
  \addtolength{\eps@titleAvailableH}{-\eps@logoH}% Resta la altura del logo
  \addtolength{\eps@titleAvailableH}{-\eps@portadaTituloY}% Resta el inicio del título
  \addtolength{\eps@titleAvailableH}{-0.5cm}% Margen de seguridad extra
  
  % 3. Bucle de optimización: Reducir fuente hasta que quepa
  % Empezamos en 55 (valor por defecto)
  \def\eps@currSize{55}%
  \loop
    % Aplicar tamaño actual
    \renewcommand{\eps@sizeTitulo}{\eps@currSize pt}%
    % Medir caja de texto
    \savebox{\eps@titleBox}{%
       \parbox{\eps@portadaTituloWidth}{%
          \eps@FuenteTituloStyle
          \linespread{\eps@leadingTitulo}\selectfont % Asegurar interlineado correcto en medición
          \EPStitulo
       }%
    }%
    \setlength{\eps@titleContentH}{\ht\eps@titleBox + \dp\eps@titleBox}%
    
    % Imprimir log para depuración (visible en .log)
    %\message{EPS-DEBUG: Font \eps@currSize pt -> Height \the\eps@titleContentH \space vs Available \the\eps@titleAvailableH}%
    
    % Condición de salida: Si la altura del contenido es MENOR que la disponible
    % O si hemos llegado al tamaño mínimo (20pt).
    \ifdim\eps@titleContentH>\eps@titleAvailableH
       \ifnum\eps@currSize>20
          \edef\eps@currSize{\the\numexpr\eps@currSize-2}% Reducir 2pt
       \else
          % Forzar salida si llegamos al mínimo
          \setlength{\eps@titleContentH}{0pt}%
       \fi
    \else
       % Cabe perfectamente, forzar salida
       \setlength{\eps@titleContentH}{0pt}%
    \fi
  \ifdim\eps@titleContentH>0pt
  \repeat
}

%% ============================================================================
%% PORTADA A COLOR
%% ============================================================================
\NewDocumentCommand{\portadacolor}{}{%
  % ---------------------------------------------------------------------------
  % AJUSTE DINÁMICO DE DISEÑO (1 vs 2 Tutores)
  % ---------------------------------------------------------------------------
  % Si hay cotutor, subimos el bloque de Autor y Tutor para ganar espacio vertical
  % y dar cabida a la línea extra del segundo tutor sin colisionar con la fecha.
  \EPSsiCotutor{%
    \renewcommand{\eps@portadaOffsetAutor}{4.9cm}%
    \renewcommand{\eps@portadaOffsetTutor}{3.4cm}%
  }{%
    \renewcommand{\eps@portadaOffsetAutor}{4.4cm}%
    \renewcommand{\eps@portadaOffsetTutor}{2.8cm}%
  }%
  
  % Configuración de página limpia
  \newgeometry{ignoreall,top=0cm,bottom=0cm,outer=0cm,inner=0cm}
  
  % Calcular tamaño óptimo del título antes de dibujar
  \eps@optimizeTitleSize
  
  \ifdefined\tikzexternaldisable\tikzexternaldisable\fi
  \thispagestyle{empty}

  % 1. COLOR DE FONDO
  \pagecolor{\EPScolorGrado}

  \begin{tikzpicture}[remember picture, overlay]

    % -------------------------------------------------------------------------
    % FRANJA NEGRA (Elemento TikZ inevitable para superponer)
    % -------------------------------------------------------------------------
    \fill[black] (current page.south west) rectangle ([yshift=\eps@portadaStripHeight]current page.south east);

    % -------------------------------------------------------------------------
    % ELEMENTO 1: LOGO SUPERIOR DERECHA (Facultad)
    % -------------------------------------------------------------------------
    \node[anchor=north east, inner sep=0pt] 
       at ([xshift=\eps@portadaLogoTRX, yshift=\eps@portadaLogoTRY]current page.north east)
       {\includegraphics[width=\eps@portadaLogoTRWidth]{\EPSlogoFacultadPortada}};

    % -------------------------------------------------------------------------
    % ELEMENTO 4: LOGO INFERIOR DERECHA (Universidad)
    % -------------------------------------------------------------------------
    \node[anchor=south east, inner sep=0pt] 
       at ([xshift=\eps@portadaLogoBRX, yshift=\eps@portadaLogoBRY]current page.south east)
       {\includegraphics[width=\eps@portadaLogoBRWidth]{\EPSlogoUniversidadPortada}};

    % -------------------------------------------------------------------------
    % CONJUNTO A: TÍTULO + TITULACIÓN
    % -------------------------------------------------------------------------
    
    % A.1 Título (Anclado South-West, crece hacia arriba)
    \node[anchor=south west, inner sep=0, align=flush left, text width=\eps@portadaTituloWidth, font=\eps@FuenteTituloStyle] 
       at ([xshift=\eps@portadaTituloX, yshift=\eps@portadaTituloY]current page.south west)
       {%
         \color{\EPScolorTexto}
         \EPStitulo
       };

    % A.2 Info Grado (Logo + Texto)
    % Se usan dos nodos independientes para alinear verticalmente logo y texto.
    
    % 1. Nodo del Logo
    \node[anchor=south west, inner sep=0] (InfoGradoLogo)
       at ([xshift=\eps@portadaInfoGradoX, yshift=\eps@portadaInfoGradoY]current page.south west)
       {\includegraphics[height=\eps@portadaInfoGradoLogoHeight]{\EPSlogoGradoPortada}};

    % 2. Nodo del Texto (Anclado al centro vertical derecho del logo)
    \node[anchor=west, inner sep=0, text width=13cm, align=flush left]
       at ([xshift=\eps@portadaGapGrado]InfoGradoLogo.east)
       {%
           \color{\EPScolorTexto}
           \FuentePortada\fontsize{\eps@sizeGrado}{\dimexpr\eps@leadingGrado\dimexpr\eps@sizeGrado\relax\relax}\selectfont
           \EPStitulacion
       };

    % -------------------------------------------------------------------------
    % CONJUNTO B: INFO PERSONAL
    % -------------------------------------------------------------------------
    % Definimos el origen del Conjunto B
    \coordinate (SetBOrigin) at ([xshift=\eps@portadaSetBX, yshift=\eps@portadaSetBY]current page.south west);

    % B.1 Tipo de Trabajo (Top Anchor - North West)
    \node[anchor=north west, inner sep=0, font=\eps@FuenteTipoTrabajo, text=white] 
        at ([yshift=\eps@portadaOffsetTipo]SetBOrigin)
        {%
          \EPStipoTrabajo
        };

    % B.2 Autor (Bloque etiqueta + nombre)
    \node[anchor=north west, inner sep=0, align=left, text=white, font=\eps@FuenteInfo] 
        at ([yshift=\eps@portadaOffsetAutor]SetBOrigin)
        {%
          \EPSetiquetaAutor: \\
          \EPSautor
        };

    % B.3 Tutor (Bloque etiqueta + nombre/s). 
    \node[anchor=north west, inner sep=0, align=left, text=white, font=\eps@FuenteInfo] 
        at ([yshift=\eps@portadaOffsetTutor]SetBOrigin)
        {%
          \EPSetiquetaTutor: \\
          \EPStutor
          \EPSsiCotutor{\\ \EPScotutor}{}
        };

    % B.4 Fecha (Bottom Anchor - South West)
    \node[anchor=south west, inner sep=0, font=\eps@FuenteInfo, text=white] 
        at ([yshift=\eps@portadaOffsetFecha]SetBOrigin)
        {%
           \EPSfecha
        };

  \end{tikzpicture}
  
  \newpage
  \nopagecolor % Restaurar fondo blanco para siguiente página
  \restoregeometry
}

%% ============================================================================
%% PORTADA EN BLANCO Y NEGRO
%% ============================================================================
\NewDocumentCommand{\portadabn}{}{%
  \begin{titlepage}
    % Configurar márgenes simétricos para esta página (2.5cm)
    \newgeometry{ignoreall,top=2cm,bottom=2cm,left=2.5cm,right=2.5cm}%
    \thispagestyle{empty}%
    
    % Título y subtítulo
    \noindent\begin{minipage}{\textwidth}
      \centering
      \begin{spacing}{1.5}
        {\huge\bfseries\EPStitulo}
      \end{spacing}
      \noindent\rule[-1ex]{\textwidth}{3pt}\\[3.5ex]
      {\large\bfseries\EPSsubtitulo\\[4cm]}
    \end{minipage}

    % Relleno hasta zona central
    \vspace{2.5cm}

    % Autor y Tutores
    \noindent\begin{minipage}{\textwidth}
      \centering
      \textbf{\EPSetiquetaAutor}\\
      {\EPSautor}\\[2.5ex]
      \textbf{\EPSetiquetaTutor}\\
      {\normalsize\EPStutor\\
        \ifx\EPStutorDpto\empty\else\small\textit{\EPStutorDpto}\\\fi
        \EPSsiCotutor{%
          \normalsize\EPScotutor\\
          \ifx\EPScotutorDpto\empty\else\small\textit{\EPScotutorDpto}\\\fi
        }{}%
      }
    \end{minipage}

    % Relleno hasta zona inferior
    \vspace*{\fill}

    % Logos y fecha
    \noindent\begin{minipage}{\textwidth}
      \centering
      \begin{center}
        \includegraphics[width=3cm]{\EPSlogoGrado}\\
        {\raggedleft\EPStitulacion}
      \end{center}
      \vspace*{2em}
      \centering
      \noindent
      \begin{minipage}[l]{6cm}
        \includegraphics[width=5cm]{\EPSlogoFacultad}
      \end{minipage}
      \begin{minipage}[r]{6cm}
        \includegraphics[width=5cm]{\EPSlogoUniversidad}
      \end{minipage}
      \\[1cm]
      \MakeUppercase{\EPSubicacion}, \EPSfecha
    \end{minipage}
  \end{titlepage}
  %
  % Restaurar geometría
  \restoregeometry
}

%% ============================================================================
%% COMANDO UNIFICADO PARA GENERAR PORTADAS
%% ============================================================================
\newif\ifeps@portadacolor
\newif\ifeps@portadabn

\pgfkeys{
  /eps/portada/.cd,
  color/.is if=eps@portadacolor,
  color/.default=true,
  bn/.is if=eps@portadabn,
  bn/.default=true,
  blanco-negro/.is if=eps@portadabn,
  ambas/.style={color=true,bn=true},
  solo-color/.style={color=true,bn=false},
  solo-bn/.style={color=false,bn=true},
}

\NewDocumentCommand{\generarportada}{O{ambas}}{%
  \eps@portadacolorfalse
  \eps@portadabnfalse
  \pgfkeys{/eps/portada/.cd,#1}%
  \ifeps@portadacolor
    \portadacolor
  \fi
  \ifeps@portadabn
    \portadabn
  \fi
}

%% ============================================================================
%% ALIAS PARA COMPATIBILIDAD
%% ============================================================================
\let\portada\generarportada

\endinput
